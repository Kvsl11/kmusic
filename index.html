<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KMusic</title>
    
    <link rel="icon" href="KMusic.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>


    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --bg-primary: #000000;
            --bg-secondary: #121212;
            --bg-tertiary: #242424;
            --bg-glass: rgba(18, 18, 18, 0.75);
            --bg-highlight: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b3b3b3;
            --border-color: rgba(255, 255, 255, 0.1);
            --brand-color: #29aae2;
        }

        body.light {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e0e0e0;
            --bg-glass: rgba(255, 255, 255, 0.85);
            --bg-highlight: #eeeeee;
            --text-primary: #000000;
            --text-secondary: #5f5f5f;
            --border-color: rgba(0, 0, 0, 0.1);
            --brand-color: #29aae2;
        }

        /* --- APPLYING THEME --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-secondary);
            -webkit-tap-highlight-color: transparent;
        }
        .bg-primary { background-color: var(--bg-primary); }
        .bg-secondary { background-color: var(--bg-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .bg-highlight { background-color: var(--bg-highlight); }
        .bg-glass { 
            background-color: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
        }
        .text-primary { color: var(--text-primary); }
        .text-secondary { color: var(--text-secondary); }
        .text-brand { color: var(--brand-color); }
        .bg-brand { background-color: var(--brand-color); }
        .border-theme { border-color: var(--border-color); }
        
        /* --- SCROLLBAR STYLES (REVISED) --- */
        .overflow-y-auto::-webkit-scrollbar,
        .overflow-x-auto::-webkit-scrollbar,
        #library-content::-webkit-scrollbar,
        #queue-list::-webkit-scrollbar,
        #lyrics-view::-webkit-scrollbar,
        #lyrics-textarea::-webkit-scrollbar,
        #sync-history-container::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .overflow-y-auto::-webkit-scrollbar-track,
        .overflow-x-auto::-webkit-scrollbar-track,
        #library-content::-webkit-scrollbar-track,
        #queue-list::-webkit-scrollbar-track,
        #lyrics-view::-webkit-scrollbar-track,
        #lyrics-textarea::-webkit-scrollbar-track,
        #sync-history-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .overflow-y-auto::-webkit-scrollbar-thumb,
        .overflow-x-auto::-webkit-scrollbar-thumb,
        #library-content::-webkit-scrollbar-thumb,
        #queue-list::-webkit-scrollbar-thumb,
        #lyrics-view::-webkit-scrollbar-thumb,
        #lyrics-textarea::-webkit-scrollbar-thumb,
        #sync-history-container::-webkit-scrollbar-thumb {
            background-color: transparent;
            border-radius: 10px;
            border: 3px solid transparent;
            background-clip: content-box;
            transition: background-color 0.3s;
        }

        .overflow-y-auto:hover::-webkit-scrollbar-thumb,
        .overflow-x-auto:hover::-webkit-scrollbar-thumb,
        #library-content:hover::-webkit-scrollbar-thumb,
        #queue-list:hover::-webkit-scrollbar-thumb,
        #lyrics-view:hover::-webkit-scrollbar-thumb,
        #lyrics-textarea:hover::-webkit-scrollbar-thumb,
        #sync-history-container:hover::-webkit-scrollbar-thumb {
            background-color: var(--brand-color);
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }


        input[type="range"] {
            -webkit-appearance: none; appearance: none; width: 100%; height: 4px;
            border-radius: 5px; background: #535353; outline: none;
            background-image: linear-gradient(var(--brand-color), var(--brand-color));
            background-size: 0% 100%;
            background-repeat: no-repeat;
            transition: background-size 0.1s;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 10px; height: 10px;
            border-radius: 50%; background: #fff; cursor: pointer; opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        .slider-container:hover input[type="range"]::-webkit-slider-thumb { opacity: 1; }
        .active-blue, .btn-icon.active, .nav-item.active, .mobile-nav-item.active { color: var(--brand-color); }

        /* Playing Song Indicator */
        .playing-indicator { display: flex; gap: 2px; height: 16px; align-items: flex-end; }
        .playing-indicator .bar { width: 3px; background-color: var(--brand-color); animation: bounce 1.2s ease-in-out infinite; }
        .playing-indicator .bar:nth-child(2) { animation-delay: -1.0s; }
        .playing-indicator .bar:nth-child(3) { animation-delay: -0.8s; }
        .playing-indicator .bar:nth-child(4) { animation-delay: -0.6s; }
        @keyframes bounce { 0%, 100% { height: 4px; } 50% { height: 16px; } }

        /* Lyrics Panel Styles (Always Dark) */
        #lyrics-panel { background-color: #000; }
        #lyrics-display-container { text-align: center; }
        #lyrics-panel .lyrics-line-wrapper {
            padding: 12px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.4s ease;
            font-weight: 800;
            opacity: 0.4;
            color: #b3b3b3;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #lyrics-panel .lyrics-line-wrapper:hover { background-color: rgba(255, 255, 255, 0.05); opacity: 1; }
        #lyrics-panel .lyrics-line-wrapper.active { color: #ffffff; opacity: 1; transform: scale(1.02); }
        #lyrics-panel .lyrics-line-wrapper.plain-text { cursor: default; }
        #lyrics-panel .lyrics-line-wrapper .lyrics-chords {
            font-size: 0.6em; /* Relative to line font size */
            color: var(--brand-color);
            margin-bottom: 4px;
            font-weight: 600;
            opacity: 0.8;
        }
        
        #lyrics-panel .text-primary, body.light #lyrics-panel .text-primary { color: #ffffff; }
        #lyrics-panel .text-secondary, body.light #lyrics-panel .text-secondary { color: #b3b3b3; }
        #lyrics-panel .btn-icon, body.light #lyrics-panel .btn-icon { color: #b3b3b3; }
        #lyrics-panel .btn-icon:hover, body.light #lyrics-panel .btn-icon:hover { color: #ffffff; }
        #lyrics-panel .btn-icon.active-blue, body.light #lyrics-panel .btn-icon.active-blue { color: var(--brand-color); }
        #lyrics-panel .border-theme { border-color: rgba(255, 255, 255, 0.1); }
        #lyrics-panel .bg-tertiary { background-color: #242424; }
        #lyrics-panel .hover\:bg-highlight:hover { background-color: #2a2a2a; }

        /* --- Now Playing Fullscreen (Always Dark) --- */
        #now-playing-fullscreen {
            background-color: #000;
        }
        #now-playing-fullscreen .text-primary, body.light #now-playing-fullscreen .text-primary {
            color: #ffffff;
        }
        #now-playing-fullscreen .text-secondary, body.light #now-playing-fullscreen .text-secondary {
            color: #b3b3b3;
        }
        #now-playing-fullscreen #close-now-playing-fullscreen, body.light #now-playing-fullscreen #close-now-playing-fullscreen {
            color: #b3b3b3;
        }
        #now-playing-fullscreen #close-now-playing-fullscreen:hover, body.light #now-playing-fullscreen #close-now-playing-fullscreen:hover {
            color: #ffffff;
        }
        #now-playing-fullscreen #go-to-lyrics-btn, body.light #now-playing-fullscreen #go-to-lyrics-btn {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        #now-playing-fullscreen #go-to-lyrics-btn:hover, body.light #now-playing-fullscreen #go-to-lyrics-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Show Timer Panel Light Theme Adjustments */
        body.light #show-timer-panel {
            background-color: rgba(229, 231, 235, 0.85);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        body.light #show-timer-panel .text-primary { color: #000000; }
        body.light #show-timer-panel .text-brand { color: #29aae2; }
        body.light #show-timer-panel button { background-color: rgba(0, 0, 0, 0.05); color: #000000; }
        body.light #show-timer-panel button:hover { background-color: rgba(0, 0, 0, 0.1); }
        body.light #show-timer-panel #show-timer-save-btn { background-color: var(--brand-color); color: #ffffff; }

        /* Lyrics Panel Dropdowns Light Theme Adjustments */
        body.light #lyrics-panel #font-size-dropdown,
        body.light #lyrics-panel #more-options-dropdown {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }
        body.light #lyrics-panel #font-size-dropdown .btn-icon,
        body.light #lyrics-panel #more-options-dropdown > div {
            color: var(--text-secondary);
        }
        body.light #lyrics-panel #font-size-dropdown .btn-icon:hover,
        body.light #lyrics-panel #more-options-dropdown > div:hover {
            color: var(--text-primary);
            background-color: var(--bg-highlight);
        }
        body.light #lyrics-panel #more-options-dropdown #delete-lyrics-btn {
            color: #f87171; /* red-400 */
        }
        body.light #lyrics-panel #more-options-dropdown #delete-lyrics-btn:hover {
            color: #dc2626; /* red-600 */
            background-color: rgba(239, 68, 68, 0.1);
        }

        /* Sync Mode Styles */
        #sync-panel {
            background-color: #000000;
        }
        #sync-panel .sync-line-prev { opacity: 0.6; font-size: 1.25rem; }
        #sync-panel .sync-line-current { opacity: 1; font-size: 3.5rem; transform: scale(1.02); color: #ffffff; }
        #sync-panel .sync-line-next { opacity: 0.4; font-size: 1.5rem; }
        
        /* Drag and Drop styles */
        .queue-item.dragging { opacity: 0.5; background-color: var(--bg-highlight); }
        .song-item-row.dragging { opacity: 0.5; background-color: var(--bg-highlight); } /* Adicionado para drag and drop de playlist */
        .song-item-row.selected { background-color: rgba(41, 170, 226, 0.2); }
        
        #up-next-notification.show { transform: translateX(0); opacity: 1; }

        /* --- Queue Panel Styling --- */
        #queue-panel {
            position: fixed; top: 0.5rem; right: 0.5rem; 
            width: 100%;
            max-width: 20rem; 
            border-radius: 0.5rem; 
            transform: translateX(calc(100% + 1rem));
            transition: transform 0.3s ease-in-out, background-color 0.3s, backdrop-filter 0.3s;
            z-index: 51; /* Aumentado para ficar acima do lyrics-panel */
            background-color: var(--bg-secondary);
        }
        
        /* Dynamic bottom positioning for Queue Panel */
        body.player-active.mobile-nav-active #queue-panel { bottom: calc(0.5rem + 92px + 80px); }
        body.player-active:not(.mobile-nav-active) #queue-panel { bottom: calc(0.5rem + 92px); }
        body.player-inactive.mobile-nav-active #queue-panel { bottom: calc(0.5rem + 80px); }
        body.player-inactive:not(.mobile-nav-active) #queue-panel { bottom: 0.5rem; }

        body.queue-open #queue-panel { transform: translateX(0); }
        
        @media (min-width: 768px) {
            body.queue-open .main-content-wrapper { 
                padding-right: calc(20rem + 0.5rem); 
                transition: padding-right 0.3s ease-in-out; 
            }
        }

        body.lyrics-active #queue-panel {
            background-color: rgba(28, 28, 28, 0.75); backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border-color);
        }
        body.light.lyrics-active #queue-panel {
            background-color: rgba(255, 255, 255, 0.75);
        }

        /* History Story Styles */
        .story-card { scroll-snap-align: start; flex: 0 0 150px; }
        .story-card-inner { transform-style: preserve-3d; transition: transform 0.6s; }
        .story-card:hover .story-card-inner { transform: rotateY(180deg); }
        .story-front, .story-back { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .story-back { transform: rotateY(180deg); }
        
        .library-filter-btn.active { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .home-header { transition: background-color 0.4s ease; }

        .history-tab.active {
            color: var(--text-primary);
            background-color: var(--bg-tertiary);
        }
        
        /* Highlight Story Styles */
        .highlight-card .progress-bar-container {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            z-index: 10;
        }
        .highlight-card .progress-segment {
            flex: 1;
            height: 3px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        .highlight-card .progress-fill {
            height: 100%;
            width: 0;
            background-color: #ffffff;
            border-radius: 2px;
        }
        .highlight-card img, .recent-song-card img {
            transition: opacity 0.4s ease-in-out, transform 1s ease-in-out;
        }
        .highlight-card .relative.z-10 {
            transition: opacity 0.4s ease-in-out;
        }

    </style>

    <script>
        (function disableInspect() {
            // Bloqueia clique direito
            document.addEventListener('contextmenu', e => e.preventDefault());

            // Bloqueia F12, Ctrl+Shift+I/J, Ctrl+U
            document.addEventListener('keydown', e => {
                const forbidden =
                e.key === 'F12' ||
                (e.ctrlKey && e.shiftKey && ['I', 'J'].includes(e.key)) ||
                (e.ctrlKey && e.key === 'U');
                if (forbidden) e.preventDefault();
            });
        })();
    </script>
</head>
<body class="bg-primary text-secondary">

    <!-- Main Layout Container -->
    <div class="h-screen w-full flex flex-col md:flex-row">
        
        <!-- Desktop Sidebar -->
        <aside class="w-72 bg-primary flex-col gap-2 p-2 hidden md:flex">
            <nav class="bg-secondary rounded-lg p-3">
                <div class="px-3 py-2">
                    <a href="#" class="nav-item flex items-center gap-5 font-bold text-md transition-colors duration-300" title="Início" id="nav-home">
                        <i class="ph-bold ph-house text-2xl"></i>
                        <span>Início</span>
                    </a>
                </div>
                <div class="px-3 py-2">
                    <a href="#" class="nav-item flex items-center gap-5 font-bold text-md transition-colors duration-300" title="Buscar" id="nav-search">
                        <i class="ph-bold ph-magnifying-glass text-2xl"></i>
                        <span>Buscar</span>
                    </a>
                </div>
                <div class="px-3 py-2">
                    <a href="#" class="nav-item flex items-center gap-5 font-bold text-md transition-colors duration-300" title="Histórico" id="nav-history">
                        <i class="ph-bold ph-clock-counter-clockwise text-2xl"></i>
                        <span>Histórico</span>
                    </a>
                </div>
            </nav>
            <div class="bg-secondary rounded-lg flex-1 flex flex-col">
                <div class="p-3 flex justify-between items-center">
                    <a href="#" class="nav-item flex items-center gap-4 font-bold text-md transition-colors duration-300" title="Sua Biblioteca" id="nav-library">
                        <i class="ph-bold ph-stack text-2xl"></i>
                        <span>Sua Biblioteca</span>
                    </a>
                    <!-- Removidos os botões de "Criar playlist" e "Adicionar músicas" da sidebar -->
                    <!-- O botão de "Criar playlist" agora está na renderização da lista de playlists -->
                    <!-- O botão de "Adicionar músicas" agora está na renderização da lista de todas as músicas -->
                </div>
                <div id="library-content" class="px-2 space-y-1 overflow-y-auto flex-1">
                   <div class="text-center text-secondary p-4" id="library-placeholder">
                        <p class="font-semibold text-primary">Crie sua primeira playlist</p>
                        <p class="text-sm">É fácil, vamos te ajudar.</p>
                   </div>
                </div>
                <div id="status-indicator" class="text-xs text-center p-2 m-2 bg-tertiary rounded-lg text-primary transition-all duration-300 hidden">...</div>
            </div>
        </aside>

        <!-- Main Content Area -->
        <div class="relative flex-1 flex flex-col min-h-0 min-w-0 main-content-wrapper">
            <main id="main-view" class="flex-1 min-h-0 flex flex-col bg-secondary md:m-2 md:rounded-lg">
            </main>
            <div class="absolute top-4 right-4 z-20">
                <button id="theme-toggle-btn" class="text-secondary hover:text-primary cursor-pointer bg-primary hover:bg-highlight rounded-full p-2 transition-colors duration-300" title="Mudar Tema">
                   <i id="theme-icon" class="ph-bold ph-sun text-xl"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Player (conditionally visible) -->
    <footer class="bg-glass p-3 h-[92px] fixed left-0 right-0 bottom-20 md:bottom-0 z-30 hidden">
           <div class="grid grid-cols-3 items-center h-full">
               <div class="flex items-center gap-3 overflow-hidden">
                   <img id="player-album-art" src="https://placehold.co/64x64/121212/b3b3b3?text=KVSL" alt="Capa" class="w-14 h-14 rounded-md shadow-md cursor-pointer flex-shrink-0">
                   <div class="overflow-hidden hidden md:block">
                       <p id="player-title" class="font-bold text-primary truncate cursor-pointer">Nenhuma música tocando</p>
                       <p id="player-artist" class="text-sm text-secondary truncate">---</p>
                   </div>
               </div>
               
               <div class="flex flex-col items-center justify-center gap-2">
                   <div class="flex items-center gap-4 md:gap-6">
                       <button id="shuffle-btn" class="btn-icon text-secondary hover:text-primary transition-colors" title="Aleatório"><i class="ph-bold ph-shuffle text-xl"></i></button>
                       <button id="prev-btn" class="btn-icon text-secondary hover:text-primary transition-colors" title="Anterior"><i class="ph-bold ph-skip-back text-2xl"></i></button>
                       <button id="play-pause-btn" class="bg-white text-black rounded-full w-10 h-10 flex items-center justify-center hover:scale-105 transition-transform" title="Tocar/Pausar">
                               <i id="play-pause-icon" class="ph-bold ph-play text-xl"></i>
                       </button>
                       <button id="next-btn" class="btn-icon text-secondary hover:text-primary transition-colors" title="Próxima"><i class="ph-bold ph-skip-forward text-2xl"></i></button>
                       <button id="repeat-btn" class="btn-icon text-secondary hover:text-primary transition-colors relative" title="Repetir">
                               <i class="ph-bold ph-repeat text-xl"></i>
                               <span id="repeat-one-indicator" class="absolute -top-1 -right-1 text-xs bg-brand text-black rounded-full h-3 w-3 flex items-center justify-center font-bold hidden">1</span>
                       </button>
                   </div>
                   <div class="hidden md:flex items-center gap-2 w-full max-w-xl slider-container">
                       <span id="current-time" class="text-xs text-secondary w-10 text-right">0:00</span>
                       <input id="progress-bar" type="range" min="0" max="100" value="0" class="w-full">
                       <span id="duration" class="text-xs text-secondary w-10">0:00</span>
                   </div>
               </div>

               <div class="flex items-center justify-end gap-2 md:gap-4">
                   <button id="lyrics-btn" class="btn-icon text-secondary hover:text-primary transition-colors" title="Letra"><i class="ph-bold ph-microphone-stage text-xl"></i></button>
                   <button id="queue-btn" class="btn-icon text-secondary hover:text-primary transition-colors" title="Fila de reprodução"><i class="ph-bold ph-list-bullets text-xl"></i></button>
                   <div class="hidden md:flex items-center gap-2 w-32 slider-container">
                       <button id="volume-icon-btn" class="btn-icon text-secondary hover:text-primary transition-colors" title="Mudo">
                               <i id="volume-icon" class="ph-bold ph-speaker-high text-xl"></i>
                       </button>
                       <input id="volume-bar" type="range" min="0" max="100" value="50" class="w-full">
                   </div>
               </div>
           </div>
    </footer>

    <!-- Mobile Bottom Navigation -->
    <nav class="bg-primary border-t border-theme h-20 fixed bottom-0 left-0 right-0 z-30 flex justify-around items-center md:hidden">
        <a href="#" id="nav-home-mobile" class="mobile-nav-item flex flex-col items-center text-secondary" title="Início">
            <i class="ph-house text-3xl"></i>
        </a>
        <a href="#" id="nav-search-mobile" class="mobile-nav-item flex flex-col items-center text-secondary" title="Buscar">
            <i class="ph-magnifying-glass text-3xl"></i>
        </a>
        <a href="#" id="nav-history-mobile" class="mobile-nav-item flex flex-col items-center text-secondary" title="Histórico">
            <i class="ph-clock-counter-clockwise text-3xl"></i>
        </a>
        <a href="#" id="nav-library-mobile" class="mobile-nav-item flex flex-col items-center text-secondary" title="Sua Biblioteca">
            <i class="ph-stack text-3xl"></i>
        </a>
    </nav>
    
    <audio id="audio-player-for-metadata" class="hidden"></audio>
    
    <aside id="queue-panel" class="p-4 flex flex-col gap-4">
        <div class="flex justify-between items-center">
            <h2 class="text-lg font-bold text-primary">Fila de Reprodução</h2>
            <button id="close-queue-btn" class="text-secondary hover:text-primary" title="Fechar fila"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="border-b border-theme pb-4">
            <h3 class="text-md font-semibold text-secondary mb-2">A tocar</h3>
            <div id="now-playing-item" class="flex items-center gap-3">
                <img id="now-playing-art" src="https://placehold.co/48x48/121212/b3b3b3?text=KVSL" alt="Capa" class="w-12 h-12 rounded-md">
                <div>
                    <p id="now-playing-title" class="font-bold text-primary">Selecione uma música</p>
                    <p id="now-playing-artist" class="text-sm text-secondary">...</p>
                </div>
            </div>
        </div>
        <div class="flex-1 flex flex-col min-h-0">
            <h3 class="text-md font-semibold text-secondary mb-2">A seguir</h3>
            <div id="queue-list" class="space-y-2 overflow-y-auto flex-1">
                <p id="queue-placeholder" class="text-sm text-secondary">Nenhuma música na fila.</p>
            </div>
        </div>
    </aside>

    <div id="now-playing-fullscreen" class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center overflow-hidden">
        <div id="now-playing-fullscreen-bg" class="absolute inset-0 bg-center bg-cover transition-all duration-1000" style="filter: blur(50px) brightness(0.4);"></div>
        <div class="relative z-10 flex flex-col items-center justify-center text-center p-8">
            <button id="close-now-playing-fullscreen" class="absolute top-6 right-8 text-2xl"><i class="ph-bold ph-x"></i></button>
            <img id="now-playing-fullscreen-art" src="https://placehold.co/300x300/121212/b3b3b3?text=KVSL" class="w-64 h-64 md:w-80 md:h-80 rounded-lg shadow-2xl mb-6">
            <h2 id="now-playing-fullscreen-title" class="text-3xl md:text-5xl font-extrabold text-primary">Título da Música</h2>
            <p id="now-playing-fullscreen-artist" class="text-lg md:text-2xl text-secondary mt-2">Nome do Artista</p>
            <button id="go-to-lyrics-btn" class="mt-8 bg-white/10 hover:bg-white/20 text-white font-bold py-3 px-6 rounded-full transition-colors">Ver Letra</button>
        </div>
    </div>

    <div id="lyrics-panel" class="hidden fixed inset-0 z-50 flex flex-col items-center overflow-hidden">
        <div id="lyrics-bg" class="absolute inset-0 bg-center bg-cover transition-all duration-1000" style="filter: blur(50px) brightness(0.4);"></div>
        
        <div id="show-timer-panel" class="hidden fixed top-28 left-1/2 -translate-x-1/2 bg-glass p-3 rounded-xl shadow-2xl z-50 flex flex-col" style="min-width: 320px; resize: both; overflow: auto;">
            <div id="show-timer-panel-drag-handle" class="w-full h-8 cursor-move -mt-3 -mx-3 mb-1"></div>
            <div class="flex items-center justify-between w-full -mt-7">
                <div class="flex items-center gap-2">
                    <i class="ph-bold ph-timer text-brand text-xl"></i>
                    <span class="font-bold text-md text-primary">Tempo de Show</span>
                </div>
                <div id="show-timer-display" class="font-mono text-2xl font-bold text-primary">00:00:00</div>
            </div>
            <div class="mt-2 flex justify-center gap-2">
                <button id="show-timer-play-pause-btn" class="bg-white/20 hover:bg-white/30 text-primary font-semibold py-1 px-3 rounded-full flex items-center gap-2 text-sm">
                    <i id="show-timer-play-pause-icon" class="ph-bold ph-play text-md"></i>
                    <span id="show-timer-play-pause-text">Iniciar</span>
                </button>
                <button id="show-timer-reset-btn" class="bg-white/20 hover:bg-white/30 text-primary font-semibold py-1 px-3 rounded-full text-sm">Zerar</button>
                <button id="show-timer-save-btn" class="bg-brand hover:opacity-80 text-white font-bold py-1 px-3 rounded-full text-sm">Salvar</button>
            </div>
        </div>

        <div class="relative z-10 w-full h-full flex flex-col p-4 md:p-8 items-center">
            <div class="w-full max-w-6xl flex justify-between items-start flex-shrink-0">
                <div class="flex items-center gap-4 md:gap-6">
                    <img id="lyrics-album-art" src="https://placehold.co/96x96/121212/b3b3b3?text=KVSL" class="w-16 h-16 md:w-24 md:h-24 rounded-lg">
                    <div>
                        <h2 id="lyrics-title" class="text-xl md:text-3xl font-extrabold text-primary">Título da Música</h2>
                        <p id="lyrics-artist" class="text-base md:text-lg text-secondary">Nome do Artista</p>
                        </div>
                </div>
                <div class="flex items-center gap-2 md:gap-4">
                    <button id="toggle-show-timer-btn" class="btn-icon text-secondary hover:text-primary" title="Temporizador de Show"><i class="ph-bold ph-timer text-xl"></i></button>
                    
                    <div class="relative" id="font-size-menu-container">
                        <button id="font-size-btn" class="btn-icon text-secondary hover:text-primary" title="Tamanho da Fonte"><i class="ph-bold ph-text-aa text-xl"></i></button>
                        <div id="font-size-dropdown" class="hidden absolute right-0 top-full mt-2 bg-tertiary rounded-md shadow-lg p-2 z-50 flex items-center gap-2">
                            <button id="decrease-lyrics-font" class="btn-icon text-secondary hover:text-primary" title="Diminuir"><i class="ph-bold ph-minus text-lg"></i></button>
                            <button id="increase-lyrics-font" class="btn-icon text-secondary hover:text-primary" title="Aumentar"><i class="ph-bold ph-plus text-lg"></i></button>
                        </div>
                    </div>

                    <div class="relative" id="more-options-menu-container">
                        <button id="more-options-btn" class="btn-icon text-secondary hover:text-primary" title="Mais Opções"><i class="ph-bold ph-dots-three-vertical text-xl"></i></button>
                        <div id="more-options-dropdown" class="hidden absolute right-0 top-full mt-2 bg-tertiary rounded-md shadow-lg p-1 z-50 whitespace-nowrap">
                            <div id="edit-lyrics-btn" class="flex items-center gap-3 px-3 py-2 hover:bg-highlight cursor-pointer"><i class="ph-bold ph-pencil-simple text-lg"></i><span>Editar Letra</span></div>
                            <div id="start-sync-btn" class="flex items-center gap-3 px-3 py-2 hover:bg-highlight cursor-pointer"><i class="ph-bold ph-arrows-clockwise text-lg"></i><span>Sincronizar</span></div>
                            <hr class="border-theme my-1">
                            <div id="generate-lyrics-ai-btn" class="flex items-center gap-3 px-3 py-2 hover:bg-highlight cursor-pointer"><i class="ph-bold ph-robot text-lg"></i><span>Gerar Letra (IA)</span></div>
                            <div id="detect-chords-ai-btn" class="flex items-center gap-3 px-3 py-2 hover:bg-highlight cursor-pointer"><i class="ph-bold ph-guitar text-lg"></i><span>Detectar Cifras (IA)</span></div>
                            <hr class="border-theme my-1">
                            <div id="delete-lyrics-btn" class="flex items-center gap-3 px-3 py-2 text-red-400 hover:bg-red-600/20 cursor-pointer"><i class="ph-bold ph-trash text-lg"></i><span>Excluir Letra</span></div>
                        </div>
                    </div>
                    
                    <button id="close-lyrics-btn" class="btn-icon text-secondary hover:text-primary" title="Fechar"><i class="ph-bold ph-x text-2xl"></i></button>
                </div>
            </div>
            
            <div id="lyrics-view" class="w-full max-w-6xl flex-1 flex flex-col items-center justify-start overflow-y-auto py-12">
                <div id="lyrics-display-container" class="w-full space-y-2"></div>
            </div>

            <div id="lyrics-edit-view" class="hidden w-full max-w-4xl flex-1 flex-col items-center justify-center">
                <textarea id="lyrics-textarea" class="w-full h-full bg-black/30 text-secondary p-4 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-brand" placeholder="Cole a letra aqui... Use [C] para cifras ou [00:01.23] para timestamps."></textarea>
                <button id="save-lyrics-changes-btn" class="mt-4 bg-brand text-white font-bold py-3 px-6 rounded-full hover:scale-105 transition-transform">Salvar Alterações</button>
            </div>
            
            <div class="w-full max-w-4xl mt-auto pt-2 border-t border-theme flex-shrink-0">
                <div class="flex flex-col items-center justify-center gap-0">
                    <div class="flex items-center gap-6">
                        <button id="lyrics-shuffle-btn" class="btn-icon text-secondary hover:text-primary transition-colors" title="Aleatório"><i class="ph-bold ph-shuffle text-xl"></i></button>
                        <button id="lyrics-prev-btn" class="btn-icon text-secondary hover:text-primary transition-colors" title="Anterior"><i class="ph-bold ph-skip-back text-2xl"></i></button>
                        <button id="lyrics-play-pause-btn" class="bg-white text-black rounded-full w-10 h-10 flex items-center justify-center hover:scale-105 transition-transform" title="Tocar/Pausar">
                                <i id="lyrics-play-pause-icon" class="ph-bold ph-play text-xl"></i>
                        </button>
                        <button id="lyrics-next-btn" class="btn-icon text-secondary hover:text-primary transition-colors" title="Próxima"><i class="ph-bold ph-skip-forward text-2xl"></i></button>
                        <button id="lyrics-repeat-btn" class="btn-icon text-secondary hover:text-primary transition-colors relative" title="Repetir">
                                <i class="ph-bold ph-repeat text-xl"></i>
                                <span id="lyrics-repeat-one-indicator" class="absolute -top-1 -right-1 text-xs bg-brand text-black rounded-full h-3 w-3 flex items-center justify-center font-bold hidden">1</span>
                        </button>
                        <button id="lyrics-queue-btn" class="btn-icon text-secondary hover:text-primary transition-colors" title="Fila de reprodução"><i class="ph-bold ph-list-bullets text-xl"></i></button>
                    </div>
                    <div class="flex items-center gap-2 w-full slider-container mt-1">
                        <span id="lyrics-current-time" class="text-xs text-secondary w-10 text-right">0:00</span>
                        <input id="lyrics-progress-bar" type="range" min="0" max="100" value="0" class="w-full">
                        <span id="lyrics-duration" class="text-xs text-secondary w-10">0:00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="sync-panel" class="hidden fixed inset-0 z-50 p-8 flex flex-col justify-between">
        <div class="w-full flex justify-between items-start flex-shrink-0">
            <div class="flex items-center gap-4">
                <img id="sync-album-art" src="https://placehold.co/64x64/121212/b3b3b3?text=KVSL" class="w-16 h-16 rounded-md shadow-lg">
                <div>
                    <h2 id="sync-title" class="text-xl font-bold text-primary">Título da Música</h2>
                    <p id="sync-artist" class="text-md text-secondary">Nome do Artista</p>
                </div>
            </div>
            <button id="exit-sync-btn" class="text-secondary hover:text-primary text-2xl" title="Cancelar Sincronização"><i class="ph-bold ph-x"></i></button>
        </div>

        <div class="text-center flex-grow flex flex-col justify-center overflow-hidden py-4">
            <div id="sync-history-container" class="flex-grow overflow-y-auto flex flex-col-reverse text-2xl">
            </div>
            <div class="py-8 flex-shrink-0">
                <p class="font-extrabold text-primary sync-line-current" id="sync-line-current">Pressione "Iniciar" para começar</p>
                <p class="font-semibold text-secondary sync-line-next" id="sync-line-next"></p>
            </div>
        </div>

        <div class="w-full max-w-2xl mx-auto flex flex-col items-center gap-4 flex-shrink-0">
            <div class="flex items-center gap-2 w-full slider-container">
                <span id="sync-current-time" class="text-xs text-secondary w-10 text-right">0:00</span>
                <input id="sync-progress-bar" type="range" min="0" max="100" value="0" class="w-full">
                <span id="sync-duration" class="text-xs text-secondary w-10">0:00</span>
            </div>
            <div class="flex items-center gap-6">
                <button id="sync-play-pause-btn" class="text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-white/10 transition-colors" title="Tocar/Pausar">
                    <i id="sync-play-pause-icon" class="ph-bold ph-play text-3xl"></i>
                </button>
                <button id="tap-sync-btn" class="bg-white text-black font-bold py-5 px-10 rounded-full text-xl hover:scale-105 transition-transform">Iniciar</button>
                <button id="finish-sync-btn" class="bg-brand text-white font-bold py-3 px-6 rounded-full hover:scale-105 transition-transform disabled:opacity-50 disabled:cursor-not-allowed">Finalizar e Salvar</button>
            </div>
        </div>
    </div>


    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-tertiary border border-red-500 text-primary rounded-lg p-6 max-w-2xl w-full shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 id="error-title" class="text-xl font-bold text-red-400 flex items-center"><i class="ph-bold ph-warning text-xl mr-3"></i>Erro</h2>
                <button id="close-error-modal" class="text-2xl text-secondary hover:text-primary"><i class="ph-bold ph-x"></i></button>
            </div>
            <div id="error-message" class="space-y-4"></div>
        </div>
    </div>

    <div id="context-menu" class="hidden absolute bg-tertiary text-primary rounded-md shadow-lg p-1 z-50">
    </div>
    
    <div id="playlist-edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-tertiary rounded-lg p-6 w-full max-w-md shadow-lg space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold text-primary">Editar detalhes</h2>
                <button id="close-playlist-edit-modal" class="text-2xl text-secondary hover:text-primary"><i class="ph-bold ph-x"></i></button>
            </div>
            <div class="flex items-center gap-4">
                <label for="playlist-cover-input" class="w-40 h-40 bg-highlight rounded-md flex-shrink-0 cursor-pointer flex items-center justify-center hover:bg-gray-600 relative group">
                    <img id="playlist-modal-cover-preview" class="w-full h-full object-cover rounded-md">
                    <div class="absolute inset-0 bg-black/50 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="ph-bold ph-pencil-simple text-2xl"></i>
                        <span class="text-sm mt-1">Escolher foto</span>
                    </div>
                </label>
                <input type="file" id="playlist-cover-input" class="hidden" accept="image/*">
                <input type="text" id="playlist-modal-name" class="w-full bg-highlight text-primary p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-brand" placeholder="Nome da playlist">
            </div>
            <button id="save-playlist-details-btn" class="w-full bg-brand text-white font-bold py-3 px-6 rounded-full hover:scale-105 transition-transform">Salvar</button>
        </div>
    </div>

    <div id="add-songs-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-tertiary rounded-lg p-6 w-full max-w-2xl shadow-lg flex flex-col h-[90vh]">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-xl font-bold text-primary">Adicionar músicas a "<span id="add-songs-playlist-name"></span>"</h2>
                <button id="close-add-songs-modal" class="text-2xl text-secondary hover:text-primary"><i class="ph-bold ph-x"></i></button>
            </div>
            <input type="text" id="add-songs-search-input" class="w-full bg-highlight text-primary p-3 rounded-md focus:outline-none focus:ring-2 focus:ring-brand mb-4 flex-shrink-0" placeholder="Buscar em todas as músicas...">
            <div id="add-songs-list" class="overflow-y-auto flex-1">
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-tertiary text-primary rounded-lg p-6 max-w-md w-full shadow-lg">
            <h2 id="confirmation-title" class="text-xl font-bold mb-4">Você tem certeza?</h2>
            <p id="confirmation-message" class="text-secondary mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="cancel-confirmation-btn" class="bg-transparent hover:bg-white/10 text-primary font-bold py-2 px-4 rounded-full">Cancelar</button>
                <button id="confirm-action-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="up-next-notification" class="hidden fixed bottom-24 right-96 bg-tertiary rounded-lg shadow-2xl p-3 w-72 z-50 flex items-center gap-3 transform transition-transform duration-500 ease-out translate-x-[calc(100%+2rem)] opacity-0">
        <img id="up-next-art" src="https://placehold.co/48x48/121212/b3b3b3?text=🎵" class="w-12 h-12 rounded-md flex-shrink-0">
        <div class="overflow-hidden">
            <p class="text-xs text-secondary">A seguir</p>
            <p id="up-next-title" class="text-sm font-bold text-primary truncate">Título da próxima música</p>
        </div>
        <div class="absolute bottom-0 left-0 w-full h-1 bg-white/20 rounded-b-lg overflow-hidden">
            <div id="up-next-timer" class="h-full bg-brand"></div>
        </div>
    </div>


    <script>
        // DOM Elements
        const playerFooter = document.querySelector('footer');
        // O input de arquivo agora está diretamente na view "Todas as Músicas"
        const addMusicInput = document.getElementById('add-music-input'); 
        const mainView = document.getElementById('main-view');
        const libraryContent = document.getElementById('library-content');
        const libraryPlaceholder = document.getElementById('library-placeholder');
        
        // Player UI Elements
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const shuffleBtn = document.getElementById('shuffle-btn');
        const repeatBtn = document.getElementById('repeat-btn');
        const repeatOneIndicator = document.getElementById('repeat-one-indicator');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeEl = document.getElementById('current-time');
        const durationEl = document.getElementById('duration');
        const volumeBar = document.getElementById('volume-bar');
        const volumeIconBtn = document.getElementById('volume-icon-btn');
        const volumeIcon = document.getElementById('volume-icon');
        const playerAlbumArt = document.getElementById('player-album-art');
        const playerTitle = document.getElementById('player-title');
        const playerArtist = document.getElementById('player-artist');

        // Queue Panel Elements
        const queuePanel = document.getElementById('queue-panel');
        const queueBtn = document.getElementById('queue-btn');
        const closeQueueBtn = document.getElementById('close-queue-btn');
        const nowPlayingArt = document.getElementById('now-playing-art');
        const nowPlayingTitle = document.getElementById('now-playing-title');
        const nowPlayingArtist = document.getElementById('now-playing-artist');
        const queueList = document.getElementById('queue-list');
        const queuePlaceholder = document.getElementById('queue-placeholder');

        // Now Playing Fullscreen Elements
        const nowPlayingFullscreen = document.getElementById('now-playing-fullscreen');
        const nowPlayingFullscreenBg = document.getElementById('now-playing-fullscreen-bg');
        const closeNowPlayingFullscreenBtn = document.getElementById('close-now-playing-fullscreen');
        const nowPlayingFullscreenArt = document.getElementById('now-playing-fullscreen-art');
        const nowPlayingFullscreenTitle = document.getElementById('now-playing-fullscreen-title');
        const nowPlayingFullscreenArtist = document.getElementById('now-playing-fullscreen-artist');
        const goToLyricsBtn = document.getElementById('go-to-lyrics-btn');

        // Lyrics Panel Elements
        const lyricsPanel = document.getElementById('lyrics-panel');
        const lyricsBg = document.getElementById('lyrics-bg');
        const lyricsBtn = document.getElementById('lyrics-btn');
        const closeLyricsBtn = document.getElementById('close-lyrics-btn');
        const lyricsAlbumArt = document.getElementById('lyrics-album-art');
        const lyricsTitle = document.getElementById('lyrics-title');
        const lyricsArtist = document.getElementById('lyrics-artist');
        const lyricsView = document.getElementById('lyrics-view');
        const lyricsDisplayContainer = document.getElementById('lyrics-display-container');
        const lyricsEditView = document.getElementById('lyrics-edit-view');
        const lyricsTextarea = document.getElementById('lyrics-textarea');
        const saveLyricsChangesBtn = document.getElementById('save-lyrics-changes-btn');
        
        // Lyrics Player Controls
        const lyricsPlayPauseBtn = document.getElementById('lyrics-play-pause-btn');
        const lyricsPlayPauseIcon = document.getElementById('lyrics-play-pause-icon');
        const lyricsNextBtn = document.getElementById('lyrics-next-btn');
        const lyricsPrevBtn = document.getElementById('lyrics-prev-btn');
        const lyricsShuffleBtn = document.getElementById('lyrics-shuffle-btn');
        const lyricsRepeatBtn = document.getElementById('lyrics-repeat-btn');
        const lyricsRepeatOneIndicator = document.getElementById('lyrics-repeat-one-indicator');
        const lyricsQueueBtn = document.getElementById('lyrics-queue-btn');
        const lyricsCurrentTimeEl = document.getElementById('lyrics-current-time');
        const lyricsDurationEl = document.getElementById('lyrics-duration');
        const lyricsProgressBar = document.getElementById('lyrics-progress-bar');
        
        // Lyrics Header Controls
        const fontSizeBtn = document.getElementById('font-size-btn');
        const fontSizeDropdown = document.getElementById('font-size-dropdown');
        const increaseLyricsFontBtn = document.getElementById('increase-lyrics-font');
        const decreaseLyricsFontBtn = document.getElementById('decrease-lyrics-font');
        const moreOptionsBtn = document.getElementById('more-options-btn');
        const moreOptionsDropdown = document.getElementById('more-options-dropdown');
        const editLyricsBtn = document.getElementById('edit-lyrics-btn');
        const startSyncBtn = document.getElementById('start-sync-btn');
        const generateLyricsAIButton = document.getElementById('generate-lyrics-ai-btn'); // New AI button
        const detectChordsAIButton = document.getElementById('detect-chords-ai-btn');     // New AI button
        const deleteLyricsBtn = document.getElementById('delete-lyrics-btn');
        
        // Show Timer Panel Elements
        const toggleShowTimerBtn = document.getElementById('toggle-show-timer-btn');
        const showTimerPanel = document.getElementById('show-timer-panel');
        const showTimerDisplay = document.getElementById('show-timer-display');
        const showTimerPlayPauseBtn = document.getElementById('show-timer-play-pause-btn');
        const showTimerPlayPauseIcon = document.getElementById('show-timer-play-pause-icon');
        const showTimerPlayPauseText = document.getElementById('show-timer-play-pause-text');
        const showTimerResetBtn = document.getElementById('show-timer-reset-btn');
        const showTimerSaveBtn = document.getElementById('show-timer-save-btn');

        // Sync Panel Elements
        const syncPanel = document.getElementById('sync-panel');
        const exitSyncBtn = document.getElementById('exit-sync-btn');
        const syncAlbumArt = document.getElementById('sync-album-art');
        const syncTitle = document.getElementById('sync-title');
        const syncArtist = document.getElementById('sync-artist');
        const syncHistoryContainer = document.getElementById('sync-history-container');
        const syncLineCurrent = document.getElementById('sync-line-current');
        const syncLineNext = document.getElementById('sync-line-next');
        const syncCurrentTime = document.getElementById('sync-current-time');
        const syncDuration = document.getElementById('sync-duration');
        const syncProgressBar = document.getElementById('sync-progress-bar');
        const syncPlayPauseBtn = document.getElementById('sync-play-pause-btn');
        const syncPlayPauseIcon = document.getElementById('sync-play-pause-icon');
        const tapSyncBtn = document.getElementById('tap-sync-btn');
        const finishSyncBtn = document.getElementById('finish-sync-btn');
        
        // Status Indicator Element
        const statusIndicator = document.getElementById('status-indicator');

        // Navigation
        const navHome = document.getElementById('nav-home');
        const navSearch = document.getElementById('nav-search');
        const navHistory = document.getElementById('nav-history');
        const navLibrary = document.getElementById('nav-library');
        const navHomeMobile = document.getElementById('nav-home-mobile');
        const navSearchMobile = document.getElementById('nav-search-mobile');
        const navHistoryMobile = document.getElementById('nav-history-mobile');
        const navLibraryMobile = document.getElementById('nav-library-mobile');
        // Removido o botão de criar playlist da sidebar, agora está na view da biblioteca
        const createPlaylistBtn = document.getElementById('create-playlist-btn-sidebar'); 
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const themeIcon = document.getElementById('theme-icon');

        // Context Menu
        const contextMenu = document.getElementById('context-menu');

        // Playlist Edit Modal
        const playlistEditModal = document.getElementById('playlist-edit-modal');
        const closePlaylistEditModalBtn = document.getElementById('close-playlist-edit-modal');
        const playlistModalCoverPreview = document.getElementById('playlist-modal-cover-preview');
        const playlistCoverInput = document.getElementById('playlist-cover-input');
        const playlistModalName = document.getElementById('playlist-modal-name');
        const savePlaylistDetailsBtn = document.getElementById('save-playlist-details-btn');
        let editingPlaylistId = null;
        let newCoverBlob = null;
        
        // Add Songs Modal
        const addSongsModal = document.getElementById('add-songs-modal');
        const closeAddSongsModalBtn = document.getElementById('close-add-songs-modal'); 
        const addSongsPlaylistName = document.getElementById('add-songs-playlist-name');
        const addSongsSearchInput = document.getElementById('add-songs-search-input');
        const addSongsList = document.getElementById('add-songs-list');
        let playlistIdToAddSongs = null;

        // Confirmation Modal
        const confirmationModal = document.getElementById('confirmation-modal');
        const confirmationTitleEl = document.getElementById('confirmation-title');
        const confirmationMessageEl = document.getElementById('confirmation-message');
        const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        let confirmCallback = null;
        
        // Up Next Notification
        const upNextNotification = document.getElementById('up-next-notification');
        const upNextArt = document.getElementById('up-next-art');
        const upNextTitle = document.getElementById('up-next-title');
        const upNextTimer = document.getElementById('up-next-timer');

        // --- App state ---
        let db;
        let songs = [];
        let playlists = [];
        let playHistory = [];
        
        // Playback State
        let currentSong = null;
        let playbackQueue = [];
        let playedSongsStack = [];
        let lastPlayedContext = [];
        let currentHistoryEntryId = null;
        let historyUpdateInterval = null;
        let isPlaying = false;
        let isShuffled = false;
        let repeatMode = 'none'; // 'none', 'all', 'one'
        
        // UI State
        let currentParsedLyrics = [];
        let lyricsFontSize = 2.2; // in rem
        let isSelectionMode = false;
        let selectedSongIds = new Set();
        let upNextNotificationShown = false;
        let upNextTimeout;
        let isQueueOpen = false;
        let isMuted = false;
        let lastVolume = 0.5;

        // Sync State
        let syncLines = [];
        let syncIndex = 0;
        let syncedLyricsData = [];
        let isSyncWaitingForStart = false;

        // Show Timer State
        let showTimerActive = false;
        let showTimerInterval = null;
        let showTimerStartTime = 0;
        let showTimerElapsed = 0;
        let wasShowTimerActiveBeforePause = false;
        let showTimerPlayHistoryIds = [];
        
        // Highlight Story State
        let highlightIntervals = {};

        // --- WEB AUDIO API STATE ---
        let audioContext;
        let currentSourceNode;
        let mainGainNode;
        let currentAudioBuffer;
        let playbackStartTime = 0;
        let playbackStartOffset = 0;
        let progressUpdateAnimation;

        // --- PLAYER VISIBILITY LOGIC ---
        function updatePlayerVisibility(show) {
            const isMobile = window.innerWidth < 768;
            if (show) {
                playerFooter.classList.remove('hidden');
                document.body.classList.add('player-active');
                document.body.classList.remove('player-inactive');
                mainView.style.paddingBottom = isMobile ? '172px' : '92px';
            } else {
                playerFooter.classList.add('hidden');
                document.body.classList.remove('player-active');
                document.body.classList.add('player-inactive');
                mainView.style.paddingBottom = isMobile ? '80px' : '0px';
            }
            // Add mobile-nav-active class for queue panel positioning
            document.body.classList.toggle('mobile-nav-active', isMobile);
        }

        // --- ERROR HANDLING & STATUS ---
        function showError(title, htmlMessage) {
            const errorModal = document.getElementById('error-modal');
            const errorTitleEl = document.getElementById('error-title');
            const errorMessageEl = document.getElementById('error-message');
            if (errorTitleEl) errorTitleEl.innerHTML = `<i class="ph-bold ph-warning text-xl mr-3"></i>${title}`;
            if (errorMessageEl) errorMessageEl.innerHTML = htmlMessage;
            if (errorModal) errorModal.classList.remove('hidden');
        }
        
        function setStatus(message, type = 'info') {
            statusIndicator.textContent = message;
            statusIndicator.classList.remove('hidden');
            if (type === 'info') statusIndicator.className = 'text-xs text-center p-2 m-2 bg-tertiary rounded-lg text-primary transition-all duration-300';
            else if (type === 'success') statusIndicator.className = 'text-xs text-center p-2 m-2 bg-brand rounded-lg text-white transition-all duration-300';
            else if (type === 'error') statusIndicator.className = 'text-xs text-center p-2 m-2 bg-red-600 rounded-lg text-white transition-all duration-300';
            
            if (type !== 'info') {
                setTimeout(() => statusIndicator.classList.add('hidden'), 3500);
            }
        }

        // --- CONFIRMATION MODAL ---
        function showConfirmation(title, message, onConfirm) {
            confirmationTitleEl.textContent = title;
            confirmationMessageEl.textContent = message;
            confirmCallback = onConfirm;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmation() {
            confirmationModal.classList.add('hidden');
            confirmCallback = null;
        }

        // --- INDEXEDDB SETUP ---
        async function initDB() {
            db = await idb.openDB('kvsl-music-db', 9, {
                upgrade(db, oldVersion) {
                    if (oldVersion < 1) {
                        db.createObjectStore('songs', { keyPath: 'id', autoIncrement: true });
                    }
                    if (oldVersion < 3) {
                        db.createObjectStore('playlists', { keyPath: 'id', autoIncrement: true });
                    }
                    if (oldVersion < 5) {
                        const historyStore = db.createObjectStore('playHistory', { keyPath: 'id', autoIncrement: true });
                        historyStore.createIndex('by-date', 'playedAt');
                    }
                    if (oldVersion < 6) {
                        db.createObjectStore('showHistory', { keyPath: 'id', autoIncrement: true });
                    }
                },
            });
            await loadAllData(true);
            initializePlayerState();
            initializeTheme();
            initializeDragAndDrop();
            updatePlayerVisibility(false); // Ensure player is hidden on start
            renderView('home');
        }

        // --- DATA HANDLING ---
        async function loadAllData(isInitialLoad = false) {
            if (!db) return;
            if (isInitialLoad) {
                setStatus('Carregando dados...', 'info');
            }
            songs = await db.getAll('songs');
            playlists = await db.getAll('playlists');
            playHistory = await db.getAll('playHistory');
            renderLibrary();
            if (isInitialLoad) {
                setStatus('Dados carregados!', 'success');
            }
        }

        async function processAndSaveFile(file) {
            if (!db) {
                console.error("Database not initialized yet.");
                setStatus('Banco de dados não está pronto, tente novamente.', 'error');
                return { success: false, name: file.name, reason: 'DB not ready.' };
            }
            if (file.type !== 'audio/mpeg') {
                console.warn(`Skipping non-MP3 file: ${file.name}`);
                return { success: false, name: file.name, reason: 'Não é um arquivo MP3.' };
            }

            try {
                const tags = await new Promise((resolve) => {
                    window.jsmediatags.read(file, {
                        onSuccess: (tag) => resolve(tag.tags || {}),
                        onError: (error) => {
                            console.warn(`Não foi possível ler as tags de ${file.name}:`, error.info);
                            resolve({});
                        }
                    });
                });

                const { title, artist, album, picture } = tags;

                let duration = 0;
                try {
                    const tempAudio = document.getElementById('audio-player-for-metadata');
                    tempAudio.src = URL.createObjectURL(file);
                    duration = await new Promise((resolve, reject) => {
                        const timer = setTimeout(() => reject(new Error('Timeout para obter duração')), 3000);
                        tempAudio.addEventListener('loadedmetadata', () => {
                            clearTimeout(timer);
                            resolve(tempAudio.duration);
                        }, { once: true });
                        tempAudio.addEventListener('error', (e) => {
                            clearTimeout(timer);
                            reject(e);
                        }, { once: true });
                    });
                    tempAudio.src = ''; // Clean up
                } catch (err) {
                    console.warn(`Não foi possível obter a duração do audio para "${file.name}":`, err);
                }

                const imageBlob = picture ? new Blob([new Uint8Array(picture.data)], { type: picture.format }) : null;
                const songData = {
                    title: title || file.name.replace(/\.mp3$/i, ''),
                    artist: artist || 'Artista Desconhecido',
                    album: album || 'Álbum Desconhecido',
                    audioBlob: file,
                    imageBlob: imageBlob,
                    duration: duration,
                    fileName: file.name,
                    uploadedAt: new Date(),
                    lyrics: '',
                    playCount: 0,
                };

                await db.add('songs', songData);
                return { success: true, name: file.name };

            } catch (error) {
                console.error(`Falha ao processar o arquivo ${file.name}:`, error);
                return { success: false, name: file.name, reason: error.message };
            }
        }
        
        // --- UI RENDERING ---
        function formatTime(seconds, showHours = false) {
            if (isNaN(seconds) || seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            const mStr = m.toString().padStart(2, '0');
            const sStr = s.toString().padStart(2, '0');
            if (showHours || h > 0) {
                return `${h.toString().padStart(2, '0')}:${mStr}:${sStr}`;
            }
            return `${mStr}:${sStr}`;
        }
        
        function formatFullDateTime(date) {
            if (!date) return 'N/A';
            return new Date(date).toLocaleString('pt-BR', { dateStyle: 'long', timeStyle: 'short' });
        }

        function setQueueOpen(isOpen) {
            isQueueOpen = isOpen;
            document.body.classList.toggle('queue-open', isQueueOpen);
            queueBtn.classList.toggle('active-blue', isQueueOpen);
            lyricsQueueBtn.classList.toggle('active-blue', isQueueOpen);
        }

        async function renderView(view, id = null) {
            mainView.innerHTML = '';
            mainView.className = 'flex-1 min-h-0 flex flex-col bg-secondary md:m-2 md:rounded-lg overflow-y-auto relative'; // Added relative positioning
            updatePlayerVisibility(document.body.classList.contains('player-active'));


            document.body.dataset.currentView = view;
            document.body.dataset.currentViewId = id;

            const allNavItems = document.querySelectorAll('.nav-item, .mobile-nav-item');
            allNavItems.forEach(item => item.classList.remove('active'));
            
            const activeDesktopItem = document.getElementById(`nav-${view}`);
            const activeMobileItem = document.getElementById(`nav-${view}-mobile`);

            if (view === 'home') {
                if (activeDesktopItem) activeDesktopItem.classList.add('active');
                if (activeMobileItem) activeMobileItem.classList.add('active');
            } else if (view === 'search') {
                if (activeDesktopItem) activeDesktopItem.classList.add('active');
                if (activeMobileItem) activeMobileItem.classList.add('active');
            } else if (view === 'history') {
                if (activeDesktopItem) activeDesktopItem.classList.add('active');
                if (activeMobileItem) activeMobileItem.classList.add('active');
            } else if (['songs', 'playlists', 'playlist'].includes(view)) {
                const libDesktop = document.getElementById('nav-library');
                const libMobile = document.getElementById('nav-library-mobile');
                if (libDesktop) libDesktop.classList.add('active');
                if (libMobile) libMobile.classList.add('active');
            }
            
            if (isSelectionMode && !['songs', 'playlist'].includes(view)) {
                toggleSelectionMode(false);
            }

            switch(view) {
                case 'home':
                    renderHomeView();
                    break;
                case 'songs':
                case 'playlists':
                    renderLibraryView(view);
                    break;
                case 'search':
                    renderSearchView();
                    break;
                case 'history':
                    renderHistoryView();
                    break;
                case 'playlist':
                    if (id) renderPlaylistView(id);
                    break;
            }
        }

        function renderHomeView() {
            const container = mainView;
            container.innerHTML = '';
            
            Object.values(highlightIntervals).forEach(clearTimeout);
            highlightIntervals = {};

            const now = new Date();
            const hours = now.getHours();
            let greeting = 'Boa noite';
            if (hours < 12) greeting = 'Bom dia';
            else if (hours < 18) greeting = 'Boa tarde';
            
            const topSongs = [...new Set(playHistory.map(p => p.songId))]
                .map(id => songs.find(s => s.id === id))
                .filter(Boolean)
                .sort((a,b) => (b.playCount || 0) - (a.playCount || 0))
                .slice(0, 5);

            const artistPlayCounts = playHistory.reduce((acc, play) => {
                const song = songs.find(s => s.id === play.songId);
                if(song && song.artist !== 'Artista Desconhecido') {
                    acc[song.artist] = (acc[song.artist] || 0) + 1;
                }
                return acc;
            }, {});
            const topArtists = Object.entries(artistPlayCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([name, count]) => {
                    const topSongForArtist = songs.find(s => s.artist === name);
                    return { name, count, imageBlob: topSongForArtist?.imageBlob };
                });

            const albumPlayCounts = playHistory.reduce((acc, play) => {
                const song = songs.find(s => s.id === play.songId);
                if(song && song.album !== 'Álbum Desconhecido') {
                    acc[song.album] = (acc[song.album] || 0) + 1;
                }
                return acc;
            }, {});
            const topAlbums = Object.entries(albumPlayCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5)
                .map(([name, count]) => {
                    const topSongForAlbum = songs.find(s => s.album === name);
                    return { name, count, imageBlob: topSongForAlbum?.imageBlob };
                });

            const highlightsHTML = [
                { title: 'Top Músicas', data: topSongs, type: 'song' },
                { title: 'Top Artistas', data: topArtists, type: 'artist' },
                { title: 'Top Álbuns', data: topAlbums, type: 'album' }
            ].map((category) => {
                if (category.data.length === 0) return '';
                const firstItem = category.data[0];
                const imageUrl = firstItem.imageBlob ? URL.createObjectURL(firstItem.imageBlob) : 'https://placehold.co/200x200/181818/b3b3b3?text=🎵';
                
                const progressSegments = category.data.map((_, i) => `
                    <div class="progress-segment ${i === 0 ? 'active' : ''}"><div class="progress-fill"></div></div>
                `).join('');

                return `
                    <div id="highlight-card-${category.type}" class="highlight-card aspect-square w-full bg-tertiary rounded-lg overflow-hidden shadow-lg relative flex flex-col justify-end p-4 group cursor-pointer">
                        <div class="progress-bar-container">${progressSegments}</div>
                        <img src="${imageUrl}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-1000 ease-in-out group-hover:scale-125">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                        <div class="relative z-10">
                            <p class="text-sm text-white/80">${category.title}</p>
                            <h3 class="text-xl md:text-2xl font-bold text-white truncate" id="highlight-title-${category.type}">${firstItem.title || firstItem.name}</h3>
                            <p class="text-sm md:text-md text-white/80 truncate" id="highlight-subtitle-${category.type}">${firstItem.artist || `${firstItem.count} reproduções`}</p>
                        </div>
                    </div>
                `;
            }).join('');

            const recentPlays = [...playHistory].reverse();
            const uniqueRecentSongIds = [...new Set(recentPlays.map(p => p.songId))];
            const recentSongs = uniqueRecentSongIds.slice(0, 10).map(id => songs.find(s => s.id === id)).filter(Boolean);

            const recentSongsHTML = recentSongs.map(song => {
                const imageUrl = song.imageBlob ? URL.createObjectURL(song.imageBlob) : 'https://placehold.co/200x200/181818/b3b3b3?text=🎵';
                return `
                    <div class="flex-shrink-0 w-36 md:w-48 group" onclick="startPlaybackFromContext(${songs.findIndex(s => s.id === song.id)}, songs)">
                        <div class="p-3 rounded-lg hover:bg-highlight transition-colors duration-300 cursor-pointer">
                            <div class="recent-song-card aspect-square w-full bg-tertiary rounded-md overflow-hidden shadow-lg relative mb-3">
                                <img src="${imageUrl}" class="w-full h-full object-cover transition-transform duration-1000 ease-in-out group-hover:scale-110">
                                <button class="absolute bottom-2 right-2 bg-brand text-white rounded-full w-10 h-10 md:w-12 md:h-12 flex items-center justify-center opacity-0 group-hover:opacity-100 group-hover:translate-y-0 translate-y-2 transform transition-all duration-300 shadow-lg">
                                    <i class="ph-bold ph-play text-xl md:text-2xl"></i>
                                </button>
                            </div>
                            <div>
                               <p class="font-bold text-primary truncate text-sm md:text-base">${song.title}</p>
                               <p class="text-xs md:text-sm text-secondary truncate">${song.artist}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            const topPlaylists = [...playlists].sort((a, b) => (b.songIds?.length || 0) - (a.songIds?.length || 0)).slice(0, 10);
            const topPlaylistsHTML = topPlaylists.map(playlist => {
                const coverHTML = generatePlaylistCover(playlist);
                return `
                   <div class="flex-shrink-0 w-36 md:w-48 group relative cursor-pointer" onclick="renderView('playlist', ${playlist.id})">
                        <div class="aspect-square w-full bg-tertiary rounded-lg overflow-hidden shadow-lg transform group-hover:scale-105 transition-transform duration-300 grid grid-cols-2 grid-rows-2">
                                    ${coverHTML}
                        </div>
                               <div class="mt-2">
                                    <p class="font-bold text-primary truncate text-sm md:text-base">${playlist.name}</p>
                                    <p class="text-xs md:text-sm text-secondary truncate">${playlist.songIds?.length || 0} músicas</p>
                               </div>
                   </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="overflow-y-auto flex-grow">
                    <div class="p-4 md:p-6 space-y-8 md:space-y-12">
                        <h1 class="text-2xl md:text-3xl font-extrabold text-primary">${greeting}</h1>
                        ${topSongs.length > 0 ? `
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-primary mb-4">Destaques para Você</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">${highlightsHTML}</div>
                        </div>` : ''}
                        ${recentSongs.length > 0 ? `
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-primary mb-4">Tocadas recentemente</h2>
                            <div class="flex gap-4 md:gap-6 overflow-x-auto pb-4">${recentSongsHTML}</div>
                        </div>` : ''}
                        ${playlists.length > 0 ? `
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-primary mb-4">Suas playlists</h2>
                            <div class="flex gap-4 md:gap-6 overflow-x-auto pb-4">${topPlaylistsHTML}</div>
                        </div>` : ''}
                        ${recentSongs.length === 0 && playlists.length === 0 && topSongs.length === 0 ? `
                        <div class="text-center text-secondary p-8 bg-tertiary rounded-lg mt-8">
                            <i class="ph-bold ph-music-notes-plus text-5xl text-brand"></i>
                            <p class="font-semibold text-primary mt-4">Sua biblioteca está vazia</p>
                            <p class="text-sm mt-1">Adicione músicas ou crie playlists para começar.</p>
                        </div>` : ''}
                    </div>
                </div>
            `;
            
            if (topSongs.length > 0) initHighlightCarousel('song', topSongs);
            if (topArtists.length > 0) initHighlightCarousel('artist', topArtists);
            if (topAlbums.length > 0) initHighlightCarousel('album', topAlbums);
        }

        function renderLibraryView(filter = 'songs') {
            document.body.dataset.libraryView = filter;
            mainView.innerHTML = `
                <header class="p-4 md:p-6 md:pr-20 flex-shrink-0 sticky top-0 bg-secondary z-10">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4 md:gap-8">
                        <div class="flex items-center gap-4 flex-shrink-0">
                            <button id="library-filter-songs" class="library-filter-btn px-4 py-2 rounded-full text-sm font-semibold transition-colors ${filter === 'songs' ? 'active' : ''}" data-filter="songs">Músicas</button>
                            <button id="library-filter-playlists" class="library-filter-btn px-4 py-2 rounded-full text-sm font-semibold transition-colors ${filter === 'playlists' ? 'active' : ''}" data-filter="playlists">Playlists</button>
                        </div>
                        <div class="relative w-full md:w-auto md:flex-grow max-w-xs">
                             <i class="ph-bold ph-magnifying-glass absolute top-1/2 left-3 -translate-y-1/2 text-secondary text-lg"></i>
                             <input type="text" id="library-search-input" class="w-full bg-tertiary text-primary pl-10 pr-4 py-2 rounded-full focus:outline-none focus:ring-1 focus:ring-brand" placeholder="Buscar em ${filter === 'songs' ? 'músicas' : 'playlists'}...">
                        </div>
                    </div>
                </header>
                <div id="library-view-content" class="flex-grow overflow-y-auto px-4 md:px-6"></div>
            `;

            if (filter === 'playlists') {
                renderPlaylistsListView();
            } else {
                renderAllSongsListView();
            }

            document.querySelectorAll('.library-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => renderView(btn.dataset.filter));
            });

            const searchInput = document.getElementById('library-search-input');
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase();
                if (filter === 'playlists') {
                    const filteredPlaylists = playlists.filter(p => p.name.toLowerCase().includes(query));
                    renderPlaylistsListView(filteredPlaylists);
                } else {
                    const filteredSongs = songs.filter(s => 
                        s.title.toLowerCase().includes(query) || 
                        s.artist.toLowerCase().includes(query) || 
                        s.album.toLowerCase().includes(query)
                    );
                    renderAllSongsListView(filteredSongs);
                }
            });
        }
        
        function renderPlaylistsListView(playlistsToRender = playlists) {
            const container = document.getElementById('library-view-content');
            
            const createPlaylistCardHTML = `
                <div class="p-4 rounded-lg bg-tertiary hover:bg-highlight transition-colors cursor-pointer flex flex-col items-center justify-center aspect-square" onclick="openPlaylistModal()">
                    <i class="ph-bold ph-plus text-5xl text-secondary group-hover:text-primary"></i>
                    <p class="mt-2 font-semibold text-primary">Criar Playlist</p>
                </div>
            `;

            const playlistsHTML = playlistsToRender.map(playlist => {
                const coverHTML = generatePlaylistCover(playlist);
                const songCount = playlist.songIds ? playlist.songIds.length : 0;
                return `
                    <div class="p-2 md:p-4 rounded-lg hover:bg-highlight transition-colors cursor-pointer" onclick="renderView('playlist', ${playlist.id})">
                        <div class="w-full aspect-square bg-tertiary flex-shrink-0 flex items-center justify-center rounded-md shadow-lg grid grid-cols-2 grid-rows-2 overflow-hidden mb-2 md:mb-4">
                                    ${coverHTML}
                        </div>
                               <div class="mt-2">
                                    <p class="font-bold text-primary truncate text-sm md:text-base">${playlist.name}</p>
                                    <p class="text-xs md:text-sm text-secondary">${songCount} música${songCount !== 1 ? 's' : ''}</p>
                               </div>
                   </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-4 md:gap-6 py-6">${createPlaylistCardHTML}${playlistsHTML}</div>`;
        }

        function renderAllSongsListView(songsToRender = songs) {
            const container = document.getElementById('library-view-content');
            const totalDuration = songsToRender.reduce((acc, song) => acc + song.duration, 0);
            container.innerHTML = `
                <div class="py-6">
                    <div class="flex items-center justify-between gap-6 mb-4">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-extrabold text-primary">Todas as Músicas</h1>
                            <p class="text-sm text-secondary mt-1">${songsToRender.length} músicas, ${formatTime(totalDuration, true)}</p>
                        </div>
                        <div class="hidden md:flex items-center gap-2">
                             <label for="add-music-input" class="bg-brand text-white font-semibold py-2 px-4 rounded-full flex items-center gap-2 cursor-pointer hover:opacity-90">
                                 <i class="ph-bold ph-plus"></i>
                                 <span>Adicionar</span>
                             </label>
                             <input type="file" id="add-music-input" multiple accept=".mp3" class="hidden"> <!-- Movido para cá -->
                             <button id="library-select-btn" class="btn-icon text-secondary hover:text-primary p-2 rounded-full hover:bg-highlight" title="Selecionar músicas">
                                 <i class="ph-bold ph-list-checks text-2xl"></i>
                             </button>
                             <button id="delete-selected-songs-btn" class="hidden btn-icon text-red-400 hover:text-red-500 p-2 rounded-full hover:bg-red-600/20" title="Excluir selecionadas">
                                 <i class="ph-bold ph-trash text-2xl"></i>
                             </button>
                             <button id="delete-all-songs-btn" class="btn-icon text-secondary hover:text-primary p-2 rounded-full hover:bg-highlight" title="Excluir todas as músicas">
                                 <i class="ph-bold ph-x text-3xl"></i>
                             </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-[auto,minmax(0,2fr),minmax(0,1fr),minmax(0,1fr),auto] gap-x-2 md:gap-x-4 text-secondary border-b border-theme p-2 mb-2 text-xs md:text-base">
                        <div id="song-list-header-col" class="w-8 text-center">#</div>
                        <div>Título</div>
                        <div class="hidden md:block">Artista</div>
                        <div class="hidden md:block">Álbum</div>
                        <div class="text-center"><i class="ph-bold ph-clock"></i></div>
                    </div>
                    <div id="library-song-list"></div>
                </div>
                <label for="add-music-input" class="md:hidden fixed bottom-24 right-6 bg-brand text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg z-40 cursor-pointer">
                    <i class="ph-bold ph-plus text-2xl"></i>
                </label>
            `;
            renderSongList(songsToRender, 'library-song-list', songsToRender);
            updateLibraryMenuState();
            
            document.getElementById('library-select-btn').addEventListener('click', () => toggleSelectionMode(!isSelectionMode, 'library'));
            document.getElementById('delete-selected-songs-btn').addEventListener('click', deleteSelectedSongs);
            document.getElementById('delete-all-songs-btn').addEventListener('click', () => {
                showConfirmation(
                    'Excluir Todas as Músicas',
                    'Você tem certeza que deseja excluir TODAS as suas músicas? Esta ação é irreversível e também limpará seu histórico de reprodução e shows salvos.',
                    deleteAllSongsFromLibrary
                );
            });

            // Adicionado o event listener para o input de arquivo aqui
            const currentAddMusicInput = document.getElementById('add-music-input');
            if (currentAddMusicInput) {
                currentAddMusicInput.addEventListener('change', async (e) => {
                    if (!db) {
                        setStatus('Aguarde, o banco de dados está inicializando...', 'info');
                        e.target.value = '';
                        return;
                    }
                    const files = e.target.files;
                    if (!files.length) return;

                    let successCount = 0;
                    let errorCount = 0;
                    const totalFiles = files.length;

                    for (let i = 0; i < totalFiles; i++) {
                        const file = files[i];
                        setStatus(`Importando ${i + 1}/${totalFiles}: ${file.name}`, 'info');
                        const result = await processAndSaveFile(file);
                        if (result.success) {
                            successCount++;
                        } else {
                            errorCount++;
                            console.error(`Falha ao importar ${result.name}: ${result.reason}`);
                        }
                    }

                    if (errorCount > 0) {
                        setStatus(`${successCount} de ${totalFiles} músicas importadas. ${errorCount} falharam.`, 'error');
                    } else {
                        setStatus(`Todas as ${successCount} músicas foram importadas com sucesso!`, 'success');
                    }

                    await loadAllData();
                    renderView('songs');
                    e.target.value = '';
                });
            }
        }

        function renderSearchView() {
            const searchCategories = [
                { name: 'Rock', color: 'bg-red-800' }, { name: 'Pop', color: 'bg-purple-800' },
                { name: 'Sertanejo', color: 'bg-yellow-800' }, { name: 'Eletrônica', color: 'bg-blue-800' },
                { name: 'Hip Hop', color: 'bg-orange-800' }, { name: 'MPB', color: 'bg-green-800' },
                { name: 'Indie', color: 'bg-indigo-800' }, { name: 'Clássica', color: 'bg-gray-800' }
            ];

            const categoriesHTML = searchCategories.map(cat => `
                <div class="aspect-square rounded-lg overflow-hidden relative ${cat.color} cursor-pointer">
                    <h3 class="text-white text-lg md:text-2xl font-bold p-2 md:p-4">${cat.name}</h3>
                    <img src="https://placehold.co/100x100/000000/ffffff?text=🎵" class="absolute -bottom-4 -right-4 w-16 h-16 md:w-24 md:h-24 rotate-[25deg]">
                </div>
            `).join('');

            mainView.innerHTML = `
                <header class="p-4 md:p-6 flex-shrink-0 sticky top-0 bg-secondary z-10">
                    <div class="relative w-full max-w-md mx-auto md:mx-0">
                        <i class="ph-bold ph-magnifying-glass absolute top-1/2 left-3 -translate-y-1/2 text-secondary text-xl"></i>
                        <input type="text" id="search-input" class="w-full bg-tertiary text-primary pl-10 pr-4 py-3 rounded-full focus:outline-none focus:ring-2 focus:ring-brand" placeholder="O que você quer ouvir?">
                    </div>
                </header>
                <div class="flex-grow overflow-y-auto px-4 md:px-6">
                    <div id="search-default-view" class="py-6">
                        <h2 class="text-xl md:text-2xl font-bold text-primary mb-4">Navegar por seções</h2>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 md:gap-6">
                            ${categoriesHTML}
                        </div>
                    </div>
                    <div id="search-results-container" class="hidden py-6"></div>
                </div>
            `;
            
            const searchInput = document.getElementById('search-input');
            const resultsContainer = document.getElementById('search-results-container');
            const defaultView = document.getElementById('search-default-view');

            searchInput.addEventListener('input', () => {
                const query = searchInput.value.toLowerCase();
                if (!query) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.add('hidden');
                    defaultView.classList.remove('hidden');
                    return;
                }

                defaultView.classList.add('hidden');
                resultsContainer.classList.remove('hidden');

                const results = songs.filter(s => 
                    s.title.toLowerCase().includes(query) ||
                    s.artist.toLowerCase().includes(query) ||
                    s.album.toLowerCase().includes(query)
                );
                resultsContainer.innerHTML = `
                    <div class="grid grid-cols-[auto,minmax(0,2fr),minmax(0,1fr),minmax(0,1fr),auto] gap-x-2 md:gap-x-4 text-secondary border-b border-theme p-2 mb-2 text-xs md:text-base">
                        <div id="song-list-header-col" class="w-8 text-center">#</div>
                        <div>Título</div>
                        <div class="hidden md:block">Artista</div>
                        <div class="hidden md:block">Álbum</div>
                        <div class="text-center"><i class="ph-bold ph-clock"></i></div>
                    </div>
                    <div id="search-song-list"></div>
                `;
                renderSongList(results, 'search-song-list', results);
            });
        }

        async function renderPlaylistView(playlistId) {
            const playlist = await db.get('playlists', playlistId);
            if (!playlist) { renderView('home'); return; }

            const playlistSongs = (playlist.songIds || []).map(id => songs.find(s => s.id === id)).filter(Boolean);
            const totalDuration = playlistSongs.reduce((acc, song) => acc + (song.duration || 0), 0);
            
            mainView.innerHTML = `
                <header class="p-4 md:p-6 flex-shrink-0 sticky top-0 bg-secondary z-10 flex flex-col gap-4">
                    <div class="flex flex-col md:flex-row items-center md:items-end gap-4 md:gap-6">
                        <div class="w-36 h-36 md:w-48 md:h-48 bg-tertiary flex-shrink-0 rounded-md shadow-lg grid grid-cols-2 grid-rows-2 overflow-hidden relative group cursor-pointer" onclick="openPlaylistModal(${playlistId})">
                            ${generatePlaylistCover(playlist)}
                            <div class="absolute inset-0 bg-black/60 flex flex-col items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <i class="ph-bold ph-pencil-simple text-3xl md:text-5xl text-white"></i>
                                <p class="text-white font-semibold mt-2 text-xs md:text-base">Editar detalhes</p>
                            </div>
                        </div>
                        <div class="flex-1 text-center md:text-left">
                            <p class="text-sm">Playlist</p>
                            <h1 class="text-4xl md:text-6xl font-extrabold text-primary break-words">${playlist.name}</h1>
                            <p class="text-sm text-secondary mt-2">${playlistSongs.length} músicas, ${formatTime(totalDuration, true)}</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between gap-4 pt-4 border-t border-theme">
                        <div class="flex items-center gap-4">
                            <button id="play-playlist-btn" class="bg-brand text-white rounded-full w-14 h-14 flex items-center justify-center hover:scale-105 transition-transform" title="Tocar playlist">
                                <i class="ph-bold ph-play text-2xl"></i>
                            </button>
                            <button id="add-songs-to-playlist-btn" class="text-secondary hover:text-primary p-2 rounded-full hover:bg-highlight" title="Adicionar músicas">
                                <i class="ph-bold ph-plus-circle text-3xl"></i>
                            </button>
                            <button id="playlist-select-btn" class="btn-icon text-secondary hover:text-primary p-2 rounded-full hover:bg-highlight" title="Selecionar músicas">
                                <i class="ph-bold ph-list-checks text-3xl"></i>
                            </button>
                            <button id="delete-selected-from-playlist-btn" class="hidden btn-icon text-red-400 hover:text-red-500 p-2 rounded-full hover:bg-red-600/20" title="Remover selecionadas da playlist">
                                <i class="ph-bold ph-trash text-3xl"></i>
                            </button>
                            <button id="delete-playlist-btn" class="text-secondary hover:text-primary p-2 rounded-full hover:bg-highlight" title="Excluir playlist">
                                <i class="ph-bold ph-x text-3xl"></i>
                            </button>
                        </div>
                        <div class="relative flex-grow max-w-xs hidden md:block">
                             <i class="ph-bold ph-magnifying-glass absolute top-1/2 left-3 -translate-y-1/2 text-secondary text-lg"></i>
                             <input type="text" id="playlist-search-input" class="w-full bg-highlight text-primary pl-10 pr-4 py-2 rounded-full focus:outline-none focus:ring-1 focus:ring-brand" placeholder="Buscar nesta playlist...">
                        </div>
                    </div>
                </header>
                <div class="flex-grow overflow-y-auto px-4">
                    <div class="grid grid-cols-[auto,minmax(0,2fr),minmax(0,1fr),auto] gap-x-2 md:gap-x-4 text-secondary border-b border-theme p-2 mb-2 text-xs md:text-base">
                        <div id="song-list-header-col" class="w-8 text-center">#</div>
                        <div>Título</div>
                        <div class="hidden md:block">Álbum</div>
                        <div class="text-center"><i class="ph-bold ph-clock"></i></div>
                    </div>
                    <div id="playlist-song-list" data-playlist-id="${playlistId}"></div> <!-- Adicionado data-playlist-id -->
                </div>
            `;
            renderSongList(playlistSongs, 'playlist-song-list', playlistSongs);
            updatePlaylistMenuState();

            document.getElementById('play-playlist-btn').addEventListener('click', () => {
                if (playlistSongs.length > 0) startPlaybackFromContext(0, playlistSongs);
            });
            document.getElementById('add-songs-to-playlist-btn').addEventListener('click', () => openAddSongsModal(playlistId));
            document.getElementById('delete-playlist-btn').addEventListener('click', () => {
                showConfirmation(
                    'Excluir Playlist',
                    `Tem certeza que deseja excluir a playlist "${playlist.name}"? Esta ação é irreversível.`,
                    () => deletePlaylist(playlistId)
                );
            });
            document.getElementById('playlist-select-btn').addEventListener('click', () => toggleSelectionMode(!isSelectionMode, 'playlist'));
            document.getElementById('delete-selected-from-playlist-btn').addEventListener('click', () => deleteSelectedSongsFromPlaylist(playlistId));

            const searchInput = document.getElementById('playlist-search-input');
            if(searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const filteredSongs = playlistSongs.filter(s => 
                        s.title.toLowerCase().includes(query) ||
                        s.artist.toLowerCase().includes(query) ||
                        s.album.toLowerCase().includes(query)
                    );
                    renderSongList(filteredSongs, 'playlist-song-list', playlistSongs);
                });
            }

            // Inicializa o drag and drop para as músicas da playlist
            initializePlaylistDragAndDrop(playlistId);
        }

        async function renderHistoryView() {
            const lastTab = localStorage.getItem('historyActiveTab') || 'dashboard';

            mainView.innerHTML = `
                <header class="p-4 md:p-6 md:pr-20 flex-shrink-0 sticky top-0 bg-secondary z-10">
                    <div class="flex items-center justify-between">
                            <h1 class="text-2xl md:text-3xl font-extrabold text-primary">Seu Histórico</h1>
                            <button id="clear-history-btn" class="bg-red-600/20 text-red-400 hover:bg-red-600/40 font-semibold py-2 px-3 md:px-4 rounded-full flex items-center gap-2 text-sm">
                                    <i class="ph-bold ph-trash"></i>
                                    <span class="hidden md:inline">Limpar Tudo</span>
                            </button>
                    </div>
                    <div id="history-tabs" class="flex items-center gap-2 mt-4 border-b border-theme overflow-x-auto">
                        <button data-tab="dashboard" class="history-tab px-3 md:px-4 py-2 rounded-t-lg text-sm font-semibold transition-colors whitespace-nowrap">Estatísticas</button>
                        <button data-tab="shows" class="history-tab px-3 md:px-4 py-2 rounded-t-lg text-sm font-semibold transition-colors whitespace-nowrap">Shows Salvos</button>
                        <button data-tab="plays" class="history-tab px-3 md:px-4 py-2 rounded-t-lg text-sm font-semibold transition-colors whitespace-nowrap">Músicas Tocadas</button>
                    </div>
                </header>
                <div class="flex-grow overflow-y-auto p-4 md:p-6 pt-0">
                    <div id="tab-content-dashboard" class="history-tab-content hidden"></div>
                    <div id="tab-content-shows" class="history-tab-content hidden"></div>
                    <div id="tab-content-plays" class="history-tab-content hidden"></div>
                </div>
            `;

            const tabsContainer = document.getElementById('history-tabs');
            tabsContainer.addEventListener('click', (e) => {
                const tabButton = e.target.closest('.history-tab');
                if (tabButton) {
                    const tabName = tabButton.dataset.tab;
                    setActiveTab(tabName);
                }
            });

            document.getElementById('clear-history-btn').addEventListener('click', () => {
                showConfirmation(
                    'Limpar Histórico Completo',
                    'Você tem certeza que deseja apagar TODO o seu histórico, incluindo shows salvos? Esta ação é irreversível.',
                    deleteAllHistory
                );
            });

            setActiveTab(lastTab);
        }

        function setActiveTab(tabName) {
            document.querySelectorAll('.history-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.history-tab-content').forEach(c => c.classList.add('hidden'));

            const activeTabButton = document.querySelector(`.history-tab[data-tab="${tabName}"]`);
            const activeTabContent = document.getElementById(`tab-content-${tabName}`);

            if (activeTabButton) activeTabButton.classList.add('active');
            if (activeTabContent) {
                activeTabContent.classList.remove('hidden');
                switch(tabName) {
                    case 'dashboard': renderDashboardTab(); break;
                    case 'shows': renderShowHistoryTab(); break;
                    case 'plays': renderRecentPlaysTab(); break;
                }
            }
            localStorage.setItem('historyActiveTab', tabName);
        }

        async function refreshActiveHistoryTab() {
            if (document.body.dataset.currentView !== 'history') return;
            const activeTabName = localStorage.getItem('historyActiveTab') || 'dashboard';
            const activeTabContent = document.getElementById(`tab-content-${activeTabName}`);
            if (activeTabContent && !activeTabContent.classList.contains('hidden')) {
                    switch(activeTabName) {
                    case 'dashboard': await renderDashboardTab(); break;
                    case 'shows': await renderShowHistoryTab(); break;
                    case 'plays': await renderRecentPlaysTab(); break;
                }
            }
        }

        async function renderDashboardTab() {
            const container = document.getElementById('tab-content-dashboard');
            if (playHistory.length < 1) {
                container.innerHTML = '<p class="text-secondary text-center py-8">Ouça algumas músicas para ver suas estatísticas aqui.</p>';
                return;
            }

            // --- Data Calculation ---
            const historyWithSongs = playHistory.map(h => ({...h, song: songs.find(s => s.id === h.songId)})).filter(h => h.song);
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - 7);
            weekStart.setHours(0, 0, 0, 0);
            const weeklyPlays = historyWithSongs.filter(h => new Date(h.playedAt) >= weekStart);
            
            // Top Song of the Week
            const weeklySongCounts = weeklyPlays.reduce((acc, h) => {
                acc[h.songId] = (acc[h.songId] || 0) + 1;
                return acc;
            }, {});
            const topWeeklySongEntry = Object.entries(weeklySongCounts).sort(([,a],[,b]) => b-a)[0];
            const topSongOfWeek = topWeeklySongEntry ? { song: songs.find(s => s.id === parseInt(topWeeklySongEntry[0])), count: topWeeklySongEntry[1] } : null;

            // Top Artist of the Week
            const weeklyArtistCounts = weeklyPlays.reduce((acc, h) => {
                acc[h.song.artist] = (acc[h.song.artist] || 0) + 1;
                return acc;
            }, {});
            const topWeeklyArtistEntry = Object.entries(weeklyArtistCounts).sort(([,a],[,b]) => b-a)[0];
            const topArtistOfWeek = topWeeklyArtistEntry ? { name: topWeeklyArtistEntry[0], count: topWeeklyArtistEntry[1] } : null;

            // Top 5 Lists
            const top5Songs = Object.entries(weeklySongCounts).sort(([,a],[,b]) => b-a).slice(0, 5).map(([id, count]) => ({ song: songs.find(s => s.id === parseInt(id)), count }));
            const top5Artists = Object.entries(weeklyArtistCounts).sort(([,a],[,b]) => b-a).slice(0, 5).map(([name, count]) => ({ name, count, song: songs.find(s => s.artist === name) }));
            
            const weeklyAlbumCounts = weeklyPlays.reduce((acc, h) => {
                acc[h.song.album] = (acc[h.song.album] || 0) + 1;
                return acc;
            }, {});
            const top5Albums = Object.entries(weeklyAlbumCounts).sort(([,a],[,b]) => b-a).slice(0, 5).map(([name, count]) => ({ name, count, song: songs.find(s => s.album === name) }));

            // --- HTML Generation ---
            const topSongHTML = topSongOfWeek ? `
                <div class="bg-tertiary rounded-lg p-6 flex flex-col md:flex-row items-center gap-6 lg:col-span-2">
                    <img src="${topSongOfWeek.song.imageBlob ? URL.createObjectURL(topSongOfWeek.song.imageBlob) : 'https://placehold.co/150x150/181818/b3b3b3?text=🎵'}" class="w-36 h-36 rounded-lg shadow-lg flex-shrink-0">
                    <div class="text-center md:text-left">
                        <p class="text-sm text-brand font-bold">TOP MÚSICA DA SEMANA</p>
                        <h3 class="text-3xl md:text-4xl font-extrabold text-primary truncate">${topSongOfWeek.song.title}</h3>
                        <p class="text-base md:text-lg text-secondary">${topSongOfWeek.song.artist}</p>
                        <p class="text-base md:text-lg text-primary mt-2">${topSongOfWeek.count} reproduções</p>
                    </div>
                </div>
            ` : '<div class="bg-tertiary rounded-lg p-6 flex items-center justify-center lg:col-span-2"><p class="text-secondary">Sem dados de música da semana.</p></div>';

            const topArtistHTML = topArtistOfWeek ? `
                <div class="bg-tertiary rounded-lg p-6">
                    <p class="text-sm text-brand font-bold">TOP ARTISTA DA SEMANA</p>
                    <h3 class="text-2xl md:text-3xl font-extrabold text-primary truncate">${topArtistOfWeek.name}</h3>
                    <p class="text-base md:text-lg text-secondary">${topArtistOfWeek.count} reproduções</p>
                </div>
            ` : '<div class="bg-tertiary rounded-lg p-6 flex items-center justify-center"><p class="text-secondary">Sem dados de artista da semana.</p></div>';
            
            const totalTimeWeek = weeklyPlays.reduce((sum, h) => sum + h.durationPlayed, 0);
            const listeningTimeHTML = `
                <div class="bg-tertiary rounded-lg p-6">
                    <p class="text-sm text-brand font-bold">TEMPO DE ESCUTA</p>
                    <h3 class="text-2xl md:text-3xl font-extrabold text-primary truncate">${formatTime(totalTimeWeek, true)}</h3>
                    <p class="text-base md:text-lg text-secondary">nos últimos 7 dias</p>
                </div>
            `;

            const generateTopListHTML = (list, type) => {
                if(list.length === 0) return '';
                return `
                    <div class="bg-tertiary p-4 rounded-lg">
                        <h4 class="font-bold text-primary mb-3">${type === 'song' ? 'Top Músicas' : (type === 'artist' ? 'Top Artistas' : 'Top Álbuns')}</h4>
                        <div class="space-y-3">
                            ${list.map((item, index) => {
                                const data = item.song || item;
                                const imageUrl = data.imageBlob ? URL.createObjectURL(data.imageBlob) : 'https://placehold.co/40x40/181818/b3b3b3?text=🎵';
                                return `
                                <div class="flex items-center gap-3">
                                    <span class="w-5 text-center text-secondary">${index + 1}</span>
                                    <img src="${imageUrl}" class="w-10 h-10 rounded-md">
                                    <div class="flex-1 overflow-hidden">
                                        <p class="font-semibold text-primary truncate">${data.title || data.name}</p>
                                        <p class="text-xs text-secondary truncate">${item.count} reproduções</p>
                                    </div>
                                </div>
                                `
                            }).join('')}
                        </div>
                    </div>
                `;
            };

            container.innerHTML = `
                <div class="space-y-8 py-6">
                    <div>
                        <h3 class="text-xl md:text-2xl font-bold text-primary mb-4">Seu Resumo da Semana</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            ${topSongHTML}
                            <div class="space-y-6">
                                ${topArtistHTML}
                                ${listeningTimeHTML}
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl md:text-2xl font-bold text-primary mb-4">Suas Listas</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${generateTopListHTML(top5Songs, 'song')}
                            ${generateTopListHTML(top5Artists, 'artist')}
                            ${generateTopListHTML(top5Albums, 'album')}
                        </div>
                    </div>

                    <div>
                        <h3 class="text-xl md:text-2xl font-bold text-primary mb-4">Atividade de Escuta</h3>
                        <div class="bg-tertiary p-4 rounded-lg"><canvas id="listeningTimeChart"></canvas></div>
                    </div>
                </div>
            `;
            
            renderListeningTimeChart(historyWithSongs);
        }
        
        async function renderShowHistoryTab() {
            const container = document.getElementById('tab-content-shows');
            const showHistory = (await db.getAll('showHistory')).reverse();

            if (showHistory.length === 0) {
                container.innerHTML = '<p class="text-secondary text-center py-8">Nenhum tempo de show salvo ainda. Use o temporizador na tela de letras para salvar um.</p>';
                return;
            }

            const showCardsHTML = showHistory.map(show => {
                const songCount = show.playHistoryIds.length;
                return `
                    <div class="bg-tertiary rounded-lg p-2 flex flex-col gap-2 history-show-card">
                        <div class="history-show-card-header flex justify-between items-center cursor-pointer hover:bg-highlight/50 transition-colors rounded-md p-2">
                            <div>
                                <p class="font-bold text-primary text-base md:text-lg">${formatFullDateTime(show.savedAt)}</p>
                                <p class="text-sm text-secondary">${songCount} música${songCount !== 1 ? 's' : ''} • ${formatTime(show.duration, true)}</p>
                            </div>
                            <button class="text-secondary hover:text-primary p-1 pointer-events-none">
                                <i class="ph-bold ph-caret-down text-xl transition-transform"></i>
                            </button>
                        </div>
                        <div class="hidden history-show-details-content border-t border-theme/50 pt-3 mt-1 px-2">
                            <p class="text-center p-4">Carregando detalhes...</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6 py-6 items-start">${showCardsHTML}</div>`;

            // Event listener para os cards de show
            container.removeEventListener('click', showHistoryCardClickHandler); // Remove o antigo se houver
            container.addEventListener('click', showHistoryCardClickHandler);
        }

        async function showHistoryCardClickHandler(e) {
            const header = e.target.closest('.history-show-card-header');
            if (!header) return;

            const card = header.closest('.history-show-card');
            const detailsEl = card.querySelector('.history-show-details-content');
            const icon = header.querySelector('i');
            
            const isHidden = detailsEl.classList.toggle('hidden');
            icon.classList.toggle('rotate-180', !isHidden); // Isso é o que controla a rotação da seta

            // Recarrega os dados apenas se o card estiver sendo expandido e os detalhes ainda não foram carregados
            if (!isHidden && detailsEl.dataset.loaded !== 'true') {
                try {
                    // Recupere o histórico de shows para encontrar o show correto
                    const showHistory = (await db.getAll('showHistory')).reverse(); // Certifique-se de que a ordem é a mesma de renderShowHistoryTab
                    const showIndex = Array.from(card.parentNode.children).indexOf(card); // Encontra o índice do card clicado
                    const show = showHistory[showIndex];

                    if (!show || !Array.isArray(show.playHistoryIds)) {
                        throw new Error("Dados de histórico do show estão corrompidos ou não encontrados.");
                    }
                    
                    const playHistoryPromises = show.playHistoryIds.map(id => db.get('playHistory', id));
                    const showPlays = (await Promise.all(playHistoryPromises)).filter(Boolean);
                    
                    const songPlays = showPlays.reduce((acc, play) => {
                        const song = songs.find(s => s.id === play.songId);
                        if (song) {
                            if (!acc[song.id]) {
                                acc[song.id] = { song, count: 0, duration: 0 };
                            }
                            acc[song.id].count++;
                            acc[song.id].duration += play.durationPlayed;
                        }
                        return acc;
                    }, {});

                    if (Object.keys(songPlays).length > 0) {
                            detailsEl.innerHTML = `
                                <div class="space-y-2">
                                ${Object.values(songPlays).map(({song, count, duration}) => `
                                    <div class="flex items-center gap-3 p-1.5 rounded-md hover:bg-highlight">
                                        <img src="${song.imageBlob ? URL.createObjectURL(song.imageBlob) : 'https://placehold.co/40x40/121212/b3b3b3?text=🎵'}" class="w-10 h-10 rounded-md">
                                        <div class="flex-1 overflow-hidden">
                                            <p class="font-semibold text-primary truncate">${song.title}</p>
                                            <p class="text-sm text-secondary truncate">${count}x • ${formatTime(duration)}</p>
                                        </div>
                                    </div>
                                `).join('')}
                                </div>
                            `;
                    } else {
                        detailsEl.innerHTML = '<p class="text-center p-2">Nenhuma música foi tocada durante este show.</p>';
                    }
                    detailsEl.dataset.loaded = 'true';
                } catch (err) {
                    console.error("Erro ao carregar detalhes do show:", err);
                    detailsEl.innerHTML = `<p class="text-center p-2 text-red-400">Erro ao carregar detalhes. ${err.message}</p>`;
                }
            }
        }


        async function renderRecentPlaysTab() {
            const container = document.getElementById('tab-content-plays');
            
            if (playHistory.length === 0) {
                container.innerHTML = '<p class="text-secondary text-center py-8">Seu histórico de músicas tocadas está vazio.</p>';
                return;
            }

            const songPlaysSummary = playHistory.reduce((acc, play) => {
                const song = songs.find(s => s.id === play.songId);
                if (!song) return acc;

                if (!acc[play.songId]) {
                    acc[play.songId] = {
                        song: song,
                        totalPlays: 0,
                        totalDuration: 0,
                        plays: []
                    };
                }

                acc[play.songId].totalPlays++;
                acc[play.songId].totalDuration += play.durationPlayed; // Corrigido para usar play.songId para o histórico de reprodução
                acc[play.songId].plays.push({
                    playedAt: play.playedAt,
                    durationPlayed: play.durationPlayed
                });

                return acc;
            }, {});

            const sortedSongs = Object.values(songPlaysSummary).sort((a, b) => {
                const lastPlayA = new Date(Math.max(...a.plays.map(p => new Date(p.playedAt))));
                const lastPlayB = new Date(Math.max(...b.plays.map(p => new Date(p.playedAt))));
                return lastPlayB - lastPlayA;
            });

            const historyCardsHTML = sortedSongs.map(summary => {
                const { song, totalPlays, totalDuration, plays } = summary;
                
                const sortedPlays = plays.sort((a, b) => new Date(b.playedAt) - new Date(a.playedAt));

                const detailsHTML = sortedPlays.map(play => `
                    <div class="flex justify-between items-center text-sm p-1.5 rounded-md hover:bg-highlight/50">
                        <span class="text-secondary">${formatFullDateTime(play.playedAt)}</span>
                        <span class="text-primary font-mono">${formatTime(play.durationPlayed)}</span>
                    </div>
                `).join('');

                return `
                    <div class="bg-tertiary rounded-lg p-2 flex flex-col gap-2 history-play-card">
                        <div class="history-play-card-header flex justify-between items-center cursor-pointer hover:bg-highlight/50 transition-colors rounded-md p-2">
                            <div class="flex items-center gap-4 flex-1 overflow-hidden">
                                <img src="${song.imageBlob ? URL.createObjectURL(song.imageBlob) : 'https://placehold.co/64x64/181818/b3b3b3?text=🎵'}" class="w-16 h-16 rounded-md flex-shrink-0">
                                <div class="flex-1 overflow-hidden">
                                    <p class="font-bold text-primary text-base md:text-lg truncate">${song.title}</p>
                                    <p class="text-sm text-secondary truncate">${song.artist}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 flex-shrink-0 ml-4">
                                <div class="text-right text-sm">
                                    <p class="text-secondary">${totalPlays} vez${totalPlays > 1 ? 'es' : ''}</p>
                                    <p class="font-bold text-primary text-base">${formatTime(totalDuration)}</p>
                                </div>
                                <button class="text-secondary hover:text-primary history-details-btn p-1">
                                    <i class="ph-bold ph-caret-down text-2xl transition-transform"></i>
                                </button>
                            </div>
                        </div>
                        <div class="hidden history-details-content border-t border-theme/50 pt-3 mt-1 px-2 space-y-1">
                            ${detailsHTML}
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 py-6 items-start">${historyCardsHTML}</div>`;

            // Event listener para os cards de histórico de plays
            container.removeEventListener('click', playHistoryCardClickHandler); // Remove o antigo se houver
            container.addEventListener('click', playHistoryCardClickHandler);
        }


        function renderListeningTimeChart(history) {
            const ctx = document.getElementById('listeningTimeChart').getContext('2d');
            if (!ctx) return;
            const computedStyle = getComputedStyle(document.body);
            const textColor = computedStyle.getPropertyValue('--text-secondary').trim();
            const borderColor = computedStyle.getPropertyValue('--border-color').trim();
            const titleColor = computedStyle.getPropertyValue('--text-primary').trim();

            const data = Array(7).fill(0);
            const today = new Date();
            today.setHours(0,0,0,0);
            
            const labels = Array(7).fill(0).map((_, i) => {
                const d = new Date(today);
                d.setDate(d.getDate() - (6-i));
                return d;
            });

            history.forEach(h => {
                const playedDate = new Date(h.playedAt);
                playedDate.setHours(0,0,0,0);
                const diffDays = Math.floor((today - playedDate) / (1000 * 60 * 60 * 24));
                if (diffDays >= 0 && diffDays < 7) {
                    data[6 - diffDays] += h.durationPlayed / 60; // in minutes
                }
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Minutos Ouvidos',
                        data: data,
                        backgroundColor: 'rgba(41, 170, 226, 0.5)',
                        borderColor: 'rgba(41, 170, 226, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: borderColor } },
                        x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'EEE' } }, ticks: { color: textColor }, grid: { color: borderColor } }
                    },
                    plugins: { legend: { display: false }, title: { display: true, text: 'Atividade nos Últimos 7 Dias', color: titleColor, font: { size: 16 } } }
                }
            });
        }
        
        function generatePlaylistCover(playlist) {
            if (playlist.coverImageBlob) {
                const url = URL.createObjectURL(playlist.coverImageBlob);
                return `<img src="${url}" class="w-full h-full object-cover col-span-2 row-span-2">`;
            }
            const playlistSongs = (playlist.songIds || []).map(id => songs.find(s => s.id === id)).filter(Boolean);
            if (playlistSongs.length === 0) {
                    return `<div class="w-full h-full bg-tertiary flex items-center justify-center col-span-2 row-span-2"><i class="ph-bold ph-music-notes text-5xl text-secondary"></i></div>`;
            }
            let coverHTML = '';
            for (let i = 0; i < 4; i++) {
                if (playlistSongs[i] && playlistSongs[i].imageBlob) {
                    const url = URL.createObjectURL(playlistSongs[i].imageBlob);
                    coverHTML += `<img src="${url}" class="w-full h-full object-cover">`;
                } else {
                    coverHTML += `<div class="w-full h-full bg-tertiary flex items-center justify-center"><i class="ph-bold ph-music-notes text-3xl text-secondary"></i></div>`;
                }
            }
            return coverHTML;
        }

        function renderSongList(songArray, containerId, contextArray) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            if (songArray.length === 0) {
                container.innerHTML = `<p class="text-secondary text-center p-4">Nenhuma música encontrada.</p>`;
                return;
            }
            songArray.forEach((song, index) => {
                const imageUrl = song.imageBlob ? URL.createObjectURL(song.imageBlob) : 'https://placehold.co/40x40/121212/b3b3b3?text=🎵';
                const isPlayingSong = song.id === (currentSong || {}).id && isPlaying;
                
                let firstColHTML = '';
                if (isSelectionMode && (document.body.dataset.currentView === 'songs' || document.body.dataset.currentView === 'playlist')) {
                    const isChecked = selectedSongIds.has(song.id);
                    firstColHTML = `<input type="checkbox" class="song-select-checkbox form-checkbox h-5 w-5 bg-transparent border-gray-600 text-brand focus:ring-brand" data-song-id="${song.id}" ${isChecked ? 'checked' : ''}>`;
                } else {
                    firstColHTML = isPlayingSong 
                        ? `<div class="playing-indicator"><div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div></div>` 
                        : `<span class="text-secondary group-hover:hidden">${index + 1}</span><i class="ph-bold ph-play text-primary hidden group-hover:block"></i>`;
                }

                const songItemEl = document.createElement('div');
                // Adicionado draggable="true" e data-song-id para drag and drop
                songItemEl.draggable = true;
                songItemEl.dataset.songId = song.id;
                songItemEl.className = `grid grid-cols-[auto,minmax(0,2fr),minmax(0,1fr),auto] md:grid-cols-[auto,minmax(0,2fr),minmax(0,1fr),minmax(0,1fr),auto] gap-x-2 md:gap-x-4 items-center p-2 rounded-lg hover:bg-highlight group song-item-row cursor-pointer ${selectedSongIds.has(song.id) ? 'selected' : ''}`;
                
                songItemEl.innerHTML = `
                    <div class="w-8 text-center relative flex items-center justify-center pointer-events-none">
                        ${firstColHTML}
                    </div>
                    <div class="flex items-center gap-3 md:gap-4 pointer-events-none overflow-hidden">
                        <img src="${imageUrl}" alt="Capa" class="w-10 h-10 rounded">
                        <div class="overflow-hidden">
                            <p class="font-semibold truncate text-sm md:text-base ${isPlayingSong ? 'text-brand' : 'text-primary'}">${song.title}</p>
                            <p class="md:hidden text-xs truncate text-secondary">${song.artist}</p>
                        </div>
                    </div>
                    <div class="text-secondary truncate pointer-events-none hidden md:block">${song.artist}</div>
                    <div class="text-secondary truncate pointer-events-none hidden md:block">${song.album}</div>
                    <div class="flex items-center gap-4 justify-end">
                        <span class="text-sm text-secondary pointer-events-none">${formatTime(song.duration)}</span>
                        <button class="text-secondary hover:text-primary opacity-0 group-hover:opacity-100 transition-opacity context-menu-btn" data-song-id="${song.id}">
                            <i class="ph-bold ph-dots-three text-xl"></i>
                        </button>
                    </div>
                `;
                container.appendChild(songItemEl);
            });

            container.querySelectorAll('.song-item-row').forEach(row => {
                const songId = parseInt(row.dataset.songId);
                row.addEventListener('click', (e) => {
                    if (e.target.closest('.context-menu-btn')) {
                        return;
                    }

                    if (isSelectionMode && (document.body.dataset.currentView === 'songs' || document.body.dataset.currentView === 'playlist')) {
                        const checkbox = row.querySelector('.song-select-checkbox');
                        if (e.target !== checkbox) {
                             checkbox.checked = !checkbox.checked;
                        }
                        updateSelection(songId, checkbox.checked);
                        row.classList.toggle('selected', checkbox.checked);
                        return;
                    }
                    
                    const songIndex = contextArray.findIndex(s => s.id === songId);
                    if (songIndex > -1) {
                        startPlaybackFromContext(songIndex, contextArray);
                    }
                });
            });

            container.querySelectorAll('.context-menu-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openContextMenu(e, parseInt(button.dataset.songId));
                });
            });
        }
        
        function renderLibrary() {
            libraryContent.innerHTML = '';
            if(playlists.length === 0 && songs.length === 0) {
                libraryContent.appendChild(libraryPlaceholder);
                return;
            }
            playlists.forEach(playlist => {
                const coverHTML = generatePlaylistCover(playlist);
                const playlistItemHTML = `<div class="flex items-center gap-3 p-2 rounded hover:bg-highlight cursor-pointer playlist-item" data-id="${playlist.id}"><div class="w-12 h-12 bg-tertiary rounded grid grid-cols-2 grid-rows-2 overflow-hidden flex-shrink-0">${coverHTML}</div><div><p class="font-semibold text-primary truncate">${playlist.name}</p><p class="text-sm text-secondary">Playlist</p></div></div>`;
                libraryContent.innerHTML += playlistItemHTML;
            });
            libraryContent.querySelectorAll('.playlist-item').forEach(item => {
                item.addEventListener('click', () => renderView('playlist', parseInt(item.dataset.id)));
            });
        }

        // --- PLAYER & QUEUE LOGIC (WEB AUDIO API) ---
        async function initAudioContext() {
            if (audioContext && audioContext.state !== 'closed') return;
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                mainGainNode = audioContext.createGain();
                mainGainNode.gain.value = isMuted ? 0 : lastVolume;
                mainGainNode.connect(audioContext.destination);

            } catch (e) {
                showError("Erro de Áudio", "Seu navegador não suporta a Web Audio API ou ocorreu um erro na inicialização do áudio. A reprodução pode não funcionar corretamente.");
                console.error("Could not create AudioContext", e);
            }
        }
        
        function stopCurrentSource() {
            if (currentSourceNode) {
                currentSourceNode.onended = null;
                try {
                    currentSourceNode.stop(0);
                } catch (e) { /* Ignore error if already stopped */ }
                currentSourceNode.disconnect();
                currentSourceNode = null;
            }
            cancelAnimationFrame(progressUpdateAnimation);
        }

        async function startPlaybackFromContext(startIndex, contextArray) {
            await initAudioContext();
            if (audioContext.state === 'suspended') {
                await audioContext.resume();
            }

            if (startIndex < 0 || startIndex >= contextArray.length) {
                console.error("startPlaybackFromContext: index out of bounds.");
                return;
            }

            lastPlayedContext = contextArray;
            playedSongsStack = [];

            const upcomingSongs = contextArray.slice(startIndex);
            
            if (isShuffled) {
                const firstSong = upcomingSongs.shift();
                const shuffledUpcoming = upcomingSongs.sort(() => Math.random() - 0.5);
                playbackQueue = [firstSong, ...shuffledUpcoming];
            } else {
                playbackQueue = upcomingSongs;
            }

            await playNextSongFromQueue(false);
        }

        async function playNextSongFromQueue(fromEndOfTrack = false) {
            if (fromEndOfTrack && repeatMode === 'one' && currentSong) {
                await playSongObject(currentSong);
                return;
            }

            if (currentSong) {
                playedSongsStack.push(currentSong);
                if (playedSongsStack.length > 50) {
                    playedSongsStack.shift();
                }
            }

            if (playbackQueue.length === 0) {
                if (repeatMode === 'all' && lastPlayedContext.length > 0) {
                    await startPlaybackFromContext(0, lastPlayedContext);
                } else {
                    stopCurrentSource();
                    currentSong = null;
                    isPlaying = false;
                    updatePlayerVisibility(false); 
                    updatePlayerUI({ title: 'Nenhuma música tocando', artist: '---', imageBlob: null, duration: 0 }); 
                    updateAllPlayerControls();
                    await stopHistoryTracking();
                    // Oculta a notificação "A seguir" quando a fila de reprodução está vazia e não há repetição
                    hideUpNextNotification(); 
                }
                return;
            }

            const nextSong = playbackQueue.shift();
            await playSongObject(nextSong);
        }

        async function playSongObject(song) {
            if (!song || !song.id) {
                console.error("playSongObject: Invalid song object provided.");
                return;
            }
            // Reset upNextNotification state for the new song
            upNextNotificationShown = false;
            clearTimeout(upNextTimeout);

            updatePlayerVisibility(true);
            await stopHistoryTracking();
            stopCurrentSource();

            currentSong = song;

            try {
                const songFromDb = await db.get('songs', song.id);
                if (!songFromDb || !songFromDb.audioBlob) {
                    throw new Error('A música selecionada não foi encontrada ou está corrompida na biblioteca.');
                }
                
                const arrayBuffer = await songFromDb.audioBlob.arrayBuffer();
                
                if (!audioContext || audioContext.state === 'closed') {
                    await initAudioContext();
                }
                currentAudioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                const masterIndex = songs.findIndex(s => s.id === songFromDb.id);
                if (masterIndex > -1) {
                    songs[masterIndex].playCount = (songs[masterIndex].playCount || 0) + 1;
                    await db.put('songs', songs[masterIndex]);
                }

                await startHistoryTracking(songFromDb.id);
                
                updatePlayerUI(songFromDb);
                renderLyricsDisplay();
                if (lyricsView) lyricsView.scrollTop = 0;
                
                renderQueue();
                
                startPlayback(0);

            } catch (error) {
                console.error("Error playing song:", error);
                showError('Erro de Reprodução', `Não foi possível tocar "${song.title}". O arquivo pode estar corrompido. Pulando para a próxima...<br><small>${error.message}</small>`);
                await playNextSongFromQueue(false);
            }
        }

        function startPlayback(offset) {
            if (!currentAudioBuffer) {
                console.error("Audio buffer not ready.");
                return;
            }
            
            stopCurrentSource();

            currentSourceNode = audioContext.createBufferSource();
            currentSourceNode.buffer = currentAudioBuffer;
            currentSourceNode.playbackRate.value = 1;

            currentSourceNode.connect(mainGainNode);
            
            currentSourceNode.onended = () => {
                if (isPlaying && currentSourceNode && !currentSourceNode.stopCalled) {
                    playNextSongFromQueue(true);
                }
            };
            
            currentSourceNode.start(0, offset);
            currentSourceNode.stopCalled = false;
            
            playbackStartOffset = offset;
            playbackStartTime = audioContext.currentTime;
            isPlaying = true;
            
            updateAllPlayerControls();
            startProgressUpdater();
        }

        async function startHistoryTracking(songId) {
            const historyEntry = {
                songId: songId,
                playedAt: new Date(),
                durationPlayed: 0
            };
            currentHistoryEntryId = await db.add('playHistory', historyEntry);
            if (showTimerActive) {
                showTimerPlayHistoryIds.push(currentHistoryEntryId);
            }
            
            historyUpdateInterval = setInterval(async () => {
                if (isPlaying && currentHistoryEntryId) {
                    const entry = await db.get('playHistory', currentHistoryEntryId);
                    if (entry) {
                        entry.durationPlayed += 1;
                        await db.put('playHistory', entry);
                    }
                }
            }, 1000);
        }

        async function stopHistoryTracking() {
            clearInterval(historyUpdateInterval);
            historyUpdateInterval = null;
            if(currentHistoryEntryId) {
                await loadAllData();
                if (document.body.dataset.currentView === 'history') {
                    await refreshActiveHistoryTab();
                } else if (document.body.dataset.currentView === 'home') {
                    renderView('home');
                }
            }
            currentHistoryEntryId = null;
        }
        
        function updatePlayerUI(song) {
            const imageUrl = song.imageBlob ? URL.createObjectURL(song.imageBlob) : 'https://placehold.co/64x64/121212/b3b3b3?text=KVSL';
            const largeImageUrl = song.imageBlob ? URL.createObjectURL(song.imageBlob) : 'https://placehold.co/96x96/121212/b3b3b3?text=KVSL';

            playerAlbumArt.src = imageUrl;
            playerTitle.textContent = song.title;
            playerArtist.textContent = song.artist;

            nowPlayingArt.src = song.imageBlob ? URL.createObjectURL(song.imageBlob) : 'https://placehold.co/48x48/121212/b3b3b3?text=KVSL';
            nowPlayingTitle.textContent = song.title;
            nowPlayingArtist.textContent = song.artist;
            
            const duration = song.duration || (currentAudioBuffer ? currentAudioBuffer.duration : 0);
            durationEl.textContent = formatTime(duration);
            if (lyricsDurationEl) lyricsDurationEl.textContent = formatTime(duration);

            lyricsBg.style.backgroundImage = `url(${imageUrl})`;
            nowPlayingFullscreenBg.style.backgroundImage = `url(${imageUrl})`;
            nowPlayingFullscreenArt.src = imageUrl;
            nowPlayingFullscreenTitle.textContent = song.title;
            nowPlayingFullscreenArtist.textContent = song.artist;

            lyricsAlbumArt.src = largeImageUrl;
            lyricsTitle.textContent = song.title;
            lyricsArtist.textContent = song.artist;
        }

        function updateAllPlayerControls() {
            const isAudioPlaying = isPlaying && !isSyncWaitingForStart;
            playPauseIcon.className = isAudioPlaying ? 'ph-bold ph-pause text-xl' : 'ph-bold ph-play text-xl';
            shuffleBtn.classList.toggle('active-blue', isShuffled);
            repeatBtn.classList.toggle('active-blue', repeatMode !== 'none');
            repeatOneIndicator.classList.toggle('hidden', repeatMode !== 'one');

            lyricsPlayPauseIcon.className = isAudioPlaying ? 'ph-bold ph-pause text-xl' : 'ph-bold ph-play text-xl';
            lyricsShuffleBtn.classList.toggle('active-blue', isShuffled);
            lyricsRepeatBtn.classList.toggle('active-blue', repeatMode !== 'none');
            lyricsRepeatOneIndicator.classList.toggle('hidden', repeatMode !== 'one');
            
            syncPlayPauseIcon.className = isAudioPlaying ? 'ph-bold ph-pause text-3xl' : 'ph-bold ph-play text-3xl';

            refreshCurrentSongList();
        }

        async function refreshCurrentSongList() {
            const currentView = document.body.dataset.currentView;
            const currentId = document.body.dataset.currentViewId ? parseInt(document.body.dataset.currentViewId) : null;
            
            if (currentView === 'songs') {
                const searchInput = document.getElementById('library-search-input');
                const query = searchInput ? searchInput.value.toLowerCase() : '';
                const filteredSongs = songs.filter(s => 
                    s.title.toLowerCase().includes(query) || 
                    s.artist.toLowerCase().includes(query) || 
                    s.album.toLowerCase().includes(query)
                );
                renderSongList(filteredSongs, 'library-song-list', filteredSongs);
            } else if (currentView === 'playlist' && currentId) {
                const playlist = await db.get('playlists', currentId);
                const playlistSongs = (playlist.songIds || []).map(id => songs.find(s => s.id === id)).filter(Boolean);
                const searchInput = document.getElementById('playlist-search-input');
                const query = searchInput ? searchInput.value.toLowerCase() : '';
                const filteredSongs = playlistSongs.filter(s => 
                    s.title.toLowerCase().includes(query) || 
                    s.artist.toLowerCase().includes(query) || 
                    s.album.toLowerCase().includes(query)
                );
                renderSongList(filteredSongs, 'playlist-song-list', playlistSongs);
            } else if (currentView === 'search') {
                const searchInput = document.getElementById('search-input');
                if (searchInput && searchInput.value) {
                    const query = searchInput.value.toLowerCase();
                    const results = songs.filter(s => 
                        s.title.toLowerCase().includes(query) ||
                        s.artist.toLowerCase().includes(query) ||
                        s.album.toLowerCase().includes(query)
                    );
                    renderSongList(results, 'search-song-list', results);
                }
            }
        }
        
        function renderQueue() {
            queueList.innerHTML = '';
            if (playbackQueue.length === 0) {
                queuePlaceholder.classList.remove('hidden');
                return;
            }
            queuePlaceholder.classList.add('hidden');

            playbackQueue.forEach((song) => {
                const queueItemEl = document.createElement('div');
                queueItemEl.draggable = true;
                queueItemEl.dataset.songId = song.id;
                
                const imageUrl = song.imageBlob ? URL.createObjectURL(song.imageBlob) : 'https://placehold.co/40x40/181818/b3b3b3?text=🎵';
                queueItemEl.className = 'queue-item flex items-center gap-3 p-1.5 rounded-lg group cursor-grab hover:bg-highlight transition-colors';
                queueItemEl.innerHTML = `
                    <img src="${imageUrl}" alt="Capa" class="w-10 h-10 rounded pointer-events-none">
                    <div class="flex-1 pointer-events-none overflow-hidden">
                        <p class="text-sm font-semibold text-primary">${song.title}</p>
                        <p class="text-xs text-secondary">${song.artist}</p>
                    </div>
                    <button class="text-secondary hover:text-primary opacity-0 group-hover:opacity-100 transition-opacity remove-from-queue-btn" data-song-id="${song.id}" title="Remover da fila">
                        <i class="ph-bold ph-x text-lg"></i>
                    </button>
                `;
                queueList.appendChild(queueItemEl);
            });

            // Add listeners for click-to-play and remove
            queueList.querySelectorAll('.queue-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.remove-from-queue-btn')) return;

                    const songIdToPlay = parseInt(item.dataset.songId);
                    const indexInQueue = playbackQueue.findIndex(s => s.id === songIdToPlay);

                    if (indexInQueue > -1) {
                        const skippedSongs = playbackQueue.slice(0, indexInQueue);
                        for (let i = skippedSongs.length - 1; i >= 0; i--) {
                            playedSongsStack.push(skippedSongs[i]);
                        }
                        
                        playbackQueue = playbackQueue.slice(indexInQueue);
                        
                        playNextSongFromQueue(false);
                    }
                });
            });

            document.querySelectorAll('.remove-from-queue-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const songIdToRemove = parseInt(button.dataset.songId);
                    const indexToRemove = playbackQueue.findIndex(s => s.id === songIdToRemove);
                    if (indexToRemove > -1) {
                        playbackQueue.splice(indexToRemove, 1);
                        renderQueue();
                    }
                });
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.queue-item:not(.dragging), .song-item-row:not(.dragging)')]; // Seleciona ambos os tipos

            return draggableElements.find(child => {
                const box = child.getBoundingClientRect();
                // Se o Y do mouse estiver na metade superior do elemento, insere antes deste elemento
                return y < box.top + box.height / 2;
            }) || null; // Se nenhum elemento for encontrado, significa que deve ser anexado no final
        }

        function addSongToNextUp(songId) {
            const songToAdd = songs.find(s => s.id === songId);
            if (songToAdd) {
                playbackQueue = playbackQueue.filter(s => s.id !== songId);
                playbackQueue.unshift(songToAdd);
                renderQueue();
                setStatus(`"${songToAdd.title}" será a próxima.`, 'success');
            }
        }

        function addSongToEndOfQueue(songId) {
            const songToAdd = songs.find(s => s.id === songId);
            if (songToAdd) {
                if (playbackQueue.some(s => s.id === songId)) {
                    setStatus(`"${songToAdd.title}" já está na fila.`, 'info');
                    return;
                }
                playbackQueue.push(songToAdd);
                renderQueue();
                setStatus(`"${songToAdd.title}" adicionada à fila.`, 'success');
            }
        }
        
        function togglePlayPause() {
            initAudioContext();
            if (!currentSong) {
                if (songs.length > 0) startPlaybackFromContext(0, songs);
                return;
            }
            if (!currentAudioBuffer) return;
            
            if (audioContext.state === 'running') {
                audioContext.suspend().then(() => {
                    isPlaying = false;
                    cancelAnimationFrame(progressUpdateAnimation);
                    if (showTimerActive) {
                        startPauseShowTimer();
                        wasShowTimerActiveBeforePause = true;
                    }
                    updateAllPlayerControls();
                });
            } else if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    isPlaying = true;
                    playbackStartTime = audioContext.currentTime; // Recalibrate start time
                    startProgressUpdater();
                    if (wasShowTimerActiveBeforePause) {
                        startPauseShowTimer();
                        wasShowTimerActiveBeforePause = false;
                    }
                    updateAllPlayerControls();
                });
            }
        }
        
        function playNext() {
            playNextSongFromQueue(false);
        }

        async function playPrev() {
            const currentTime = isPlaying ? playbackStartOffset + (audioContext.currentTime - playbackStartTime) : playbackStartOffset;
            if (currentTime > 3) {
                startPlayback(0);
                return;
            }

            if (playedSongsStack.length > 0) {
                const previousSong = playedSongsStack.pop();
                if (currentSong) {
                    playbackQueue.unshift(currentSong);
                }
                await playSongObject(previousSong);
            } else {
                startPlayback(0);
            }
        }
        
        function toggleShuffle() {
            isShuffled = !isShuffled;
            if (isShuffled && playbackQueue.length > 1) {
                for (let i = playbackQueue.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [playbackQueue[i], playbackQueue[j]] = [playbackQueue[j], playbackQueue[i]];
                }
            } else {
                if (currentSong) {
                    const currentSongId = currentSong.id;
                    const currentSongIndexInLastContext = lastPlayedContext.findIndex(s => s.id === currentSongId);
                    if (currentSongIndexInLastContext > -1) {
                        playbackQueue = lastPlayedContext.slice(currentSongIndexInLastContext + 1);
                    }
                }
            }
            renderQueue();
            updateAllPlayerControls();
        }

        function cycleRepeatMode() {
            if (repeatMode === 'none') repeatMode = 'all';
            else if (repeatMode === 'all') repeatMode = 'one';
            else repeatMode = 'none';
            updateAllPlayerControls();
        }

        function renderLyricsDisplay() {
            if (!currentSong) {
                lyricsDisplayContainer.innerHTML = '<p class="text-2xl text-center">Nenhuma letra para esta música.</p>';
                return;
            }
            const lrcText = currentSong.lyrics || '';
            currentParsedLyrics = parseLyrics(lrcText);
            
            lyricsDisplayContainer.innerHTML = '';
            if (currentParsedLyrics.length === 0) {
                // If no timestamped lyrics, display as plain text
                const plainText = lrcText
                    .replace(/\[.*?\]/g, '') // Remove any remaining [tags]
                    .split('\n')
                    .map(line => `<div class="lyrics-line-wrapper plain-text"><p class="lyrics-line">${line.trim() || '&nbsp;'}</p></div>`)
                    .join('');
                lyricsDisplayContainer.innerHTML = plainText || '<div class="lyrics-line-wrapper plain-text"><p class="lyrics-line">Nenhuma letra para esta música.</p></div>';
                applyLyricsFontSize();
                return;
            }

            currentParsedLyrics.forEach(lineData => {
                const lineWrapperEl = document.createElement('div');
                lineWrapperEl.className = 'lyrics-line-wrapper';

                // Render chords if present
                if (lineData.chords && lineData.chords.length > 0) {
                    const chordsEl = document.createElement('p');
                    chordsEl.className = 'lyrics-chords';
                    chordsEl.textContent = lineData.chords.map(c => c.chord).join(' '); // Join chords with space
                    lineWrapperEl.appendChild(chordsEl);
                }

                const lineEl = document.createElement('p');
                lineEl.className = 'lyrics-line';
                lineEl.textContent = lineData.text || '♪'; // Use '♪' for empty lines with timestamps

                if (lineData.time !== null) {
                    lineEl.dataset.time = lineData.time;
                    lineWrapperEl.onclick = () => {
                        if (currentAudioBuffer) {
                            startPlayback(lineData.time);
                        }
                    };
                } else {
                    lineWrapperEl.classList.add('plain-text');
                }
                
                lineWrapperEl.appendChild(lineEl);
                lyricsDisplayContainer.appendChild(lineWrapperEl);
            });
            applyLyricsFontSize();
        }
        
        function applyLyricsFontSize() {
            const sizeRem = `${lyricsFontSize}rem`;
            const lineHeight = `${lyricsFontSize * 1.5}rem`;
            lyricsDisplayContainer.querySelectorAll('.lyrics-line').forEach(line => {
                line.style.fontSize = sizeRem;
                line.style.lineHeight = lineHeight;
            });
        }

        function syncLyrics(currentTime) {
            if (currentParsedLyrics.length === 0 || !currentParsedLyrics.some(l => l.time !== null)) return;
            
            let activeLineIndex = -1;
            for (let i = 0; i < currentParsedLyrics.length; i++) {
                if (currentParsedLyrics[i].time !== null && currentTime >= currentParsedLyrics[i].time) {
                    activeLineIndex = i;
                } else {
                    if (activeLineIndex > -1) break;
                }
            }

            lyricsDisplayContainer.querySelectorAll('.lyrics-line-wrapper').forEach((lineEl, index) => {
                if (index === activeLineIndex) {
                    if (!lineEl.classList.contains('active')) {
                        lineEl.classList.add('active');
                        // Smooth scroll into view, but only if it's not already mostly visible
                        const rect = lineEl.getBoundingClientRect();
                        const containerRect = lyricsView.getBoundingClientRect();
                        if (rect.top < containerRect.top || rect.bottom > containerRect.bottom) {
                            lineEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                } else {
                    lineEl.classList.remove('active');
                }
            });
        }

        function toggleLyricsEditMode(editing) {
            if (editing) {
                lyricsView.classList.add('hidden');
                lyricsEditView.classList.remove('hidden');
                lyricsEditView.classList.add('flex');
            } else {
                lyricsView.classList.remove('hidden');
                lyricsEditView.classList.add('hidden');
                lyricsEditView.classList.remove('flex');
            }
        }

        async function saveLyricsChanges() {
            if (!currentSong) return;
            
            const songId = currentSong.id;
            const newLyrics = lyricsTextarea.value;

            const songToUpdate = await db.get('songs', songId);
            if (!songToUpdate) {
                showError('Erro', 'Música não encontrada no banco de dados.');
                return;
            }

            songToUpdate.lyrics = newLyrics;
            await db.put('songs', songToUpdate);
            
            await loadAllData();
            currentSong.lyrics = newLyrics; // Update current song object in memory

            renderLyricsDisplay();
            toggleLyricsEditMode(false);
            setStatus('Letra salva!', 'success');
        }

        async function deleteLyrics() {
            if (!currentSong) return;
            showConfirmation(
                'Excluir Letra',
                'Tem certeza que deseja excluir a letra desta música?',
                async () => {
                    const songToUpdate = await db.get('songs', currentSong.id);
                    songToUpdate.lyrics = '';
                    await db.put('songs', songToUpdate);
                    currentSong.lyrics = '';
                    lyricsTextarea.value = '';
                    renderLyricsDisplay();
                    toggleLyricsEditMode(false);
                    setStatus('Letra excluída!', 'success');
                }
            );
        }

        async function startSyncMode() {
            if (!currentSong) {
                setStatus('Nenhuma música selecionada para sincronizar.', 'error');
                return;
            }
            const song = await db.get('songs', currentSong.id);
            const rawLyrics = song.lyrics;
            
            // Extract only plain text lines for syncing, ignoring timestamps and chords
            syncLines = rawLyrics.split('\n')
                .map(line => {
                    // Remove existing timestamps and then any chord annotations
                    return line.replace(/^\[\d{2}:\d{2}\.\d{2,3}\]/, '').replace(/\[.*?\]/g, '').trim();
                })
                .filter(line => line !== ''); // Filter out empty lines after cleaning
            
            if (syncLines.length === 0) {
                setStatus('A letra está vazia ou não contém texto para sincronizar. Adicione a letra primeiro.', 'error');
                return;
            }

            syncIndex = 0;
            syncedLyricsData = [];
            isSyncWaitingForStart = true;
            
            syncAlbumArt.src = song.imageBlob ? URL.createObjectURL(song.imageBlob) : 'https://placehold.co/64x64/121212/b3b3b3?text=KVSL';
            syncTitle.textContent = song.title;
            syncArtist.textContent = song.artist;

            lyricsPanel.classList.add('hidden');
            syncPanel.classList.remove('hidden');
            syncPanel.classList.add('flex');

            // Temporarily pause playback for sync setup
            if (isPlaying) {
                togglePlayPause();
            }
            
            const duration = currentAudioBuffer ? currentAudioBuffer.duration : 0;
            syncDuration.textContent = formatTime(duration);
            syncCurrentTime.textContent = formatTime(0);
            syncProgressBar.value = 0;
            syncProgressBar.style.backgroundSize = '0% 100%';
            
            finishSyncBtn.disabled = true;
            finishSyncBtn.classList.add('opacity-50', 'cursor-not-allowed');

            updateSyncView();
        }

        function updateSyncView() {
            syncHistoryContainer.innerHTML = '';
            // Display history in reverse order (most recent at top)
            for (let i = syncedLyricsData.length - 1; i >= 0; i--) {
                const lineData = syncedLyricsData[i];
                const lineEl = document.createElement('p');
                const timeFormatted = `[${formatTime(lineData.time)}] `;
                lineEl.textContent = `${timeFormatted}${lineData.text}`;
                lineEl.className = 'sync-line-prev py-1 cursor-pointer hover:text-white';
                lineEl.dataset.index = i;
                lineEl.onclick = () => jumpToSyncIndex(i);
                syncHistoryContainer.appendChild(lineEl);
            }
            
            syncLineCurrent.textContent = syncLines[syncIndex] || 'Tudo pronto! Pressione "Finalizar e Salvar".';
            syncLineNext.textContent = syncLines[syncIndex + 1] ? `A seguir: ${syncLines[syncIndex + 1]}` : '';

            if (syncIndex >= syncLines.length) {
                tapSyncBtn.classList.add('hidden');
                finishSyncBtn.disabled = false;
                finishSyncBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                tapSyncBtn.textContent = isSyncWaitingForStart ? 'Iniciar' : 'Marcar Tempo';
                tapSyncBtn.classList.remove('hidden');
                finishSyncBtn.disabled = true;
                finishSyncBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        function jumpToSyncIndex(index) {
            if (isSyncWaitingForStart) return;
            syncIndex = index;
            // Adjust playback offset to the selected line's time
            if (syncedLyricsData[index] && currentAudioBuffer) {
                startPlayback(syncedLyricsData[index].time);
            }
            updateSyncView();
        }

        function tapSync() {
            if (isSyncWaitingForStart) {
                isSyncWaitingForStart = false;
                if (!isPlaying) togglePlayPause();
                updateSyncView();
                return;
            }

            if (syncIndex >= syncLines.length) return;
            
            const time = playbackStartOffset + (audioContext.currentTime - playbackStartTime);
            const text = syncLines[syncIndex];
            syncedLyricsData.push({ time, text }); // Push to end, then sort later if needed, or just keep pushing
            syncIndex++;
            updateSyncView();
        }

        async function finishSync() {
            let lrcString = '';
            syncedLyricsData.forEach(line => {
                const totalSeconds = line.time;
                const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                const seconds = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
                const milliseconds = Math.round((totalSeconds - Math.floor(totalSeconds)) * 100).toString().padStart(2, '0');
                lrcString += `[${minutes}:${seconds}.${milliseconds}]${line.text}\n`;
            });
            
            const songToUpdate = await db.get('songs', currentSong.id);
            songToUpdate.lyrics = lrcString;
            await db.put('songs', songToUpdate);
            currentSong.lyrics = lrcString;

            syncPanel.classList.add('hidden');
            syncPanel.classList.remove('flex');
            lyricsPanel.classList.remove('hidden');
            document.body.classList.add('lyrics-active');

            renderLyricsDisplay();
            toggleLyricsEditMode(false);
            
            tapSyncBtn.classList.remove('hidden');

            setStatus('Letra sincronizada e salva!', 'success');
        }
        
        function openContextMenu(event, songId) {
            contextMenu.innerHTML = '';
            contextMenu.classList.remove('hidden');
            
            const currentView = document.body.dataset.currentView;
            const currentViewId = parseInt(document.body.dataset.currentViewId);

            const playNextEl = document.createElement('div');
            playNextEl.innerHTML = '<i class="ph-bold ph-arrow-bend-up-right text-lg mr-3"></i><span>Tocar a seguir</span>';
            playNextEl.className = 'flex items-center px-3 py-2 hover:bg-highlight cursor-pointer whitespace-nowrap';
            playNextEl.onclick = () => {
                addSongToNextUp(songId);
                contextMenu.classList.add('hidden');
            };
            contextMenu.appendChild(playNextEl);

            const addToQueueEl = document.createElement('div');
            addToQueueEl.innerHTML = '<i class="ph-bold ph-list-plus text-lg mr-3"></i><span>Adicionar à fila</span>';
            addToQueueEl.className = 'flex items-center px-3 py-2 hover:bg-highlight cursor-pointer whitespace-nowrap';
            addToQueueEl.onclick = () => {
                addSongToEndOfQueue(songId);
                contextMenu.classList.add('hidden');
            };
            contextMenu.appendChild(addToQueueEl);

            const addToPlaylistEl = document.createElement('div');
            addToPlaylistEl.innerHTML = '<i class="ph-bold ph-plus text-lg mr-3"></i><span>Adicionar à playlist</span><i class="ph-bold ph-caret-right text-lg ml-auto"></i>';
            addToPlaylistEl.className = 'flex items-center px-3 py-2 hover:bg-highlight cursor-pointer relative whitespace-nowrap';
            
            const subMenu = document.createElement('div');
            subMenu.className = 'hidden absolute top-0 bg-tertiary rounded-md shadow-lg p-1 min-w-[150px]';
            
            if (playlists.length === 0) {
                const noPlaylistsEl = document.createElement('div');
                noPlaylistsEl.textContent = 'Nenhuma playlist';
                noPlaylistsEl.className = 'px-3 py-2 text-secondary';
                subMenu.appendChild(noPlaylistsEl);
            } else {
                playlists.forEach(playlist => {
                    const playlistItemEl = document.createElement('div');
                    playlistItemEl.textContent = playlist.name;
                    playlistItemEl.className = 'px-3 py-2 hover:bg-highlight cursor-pointer whitespace-nowrap';
                    playlistItemEl.onclick = async (e) => {
                        e.stopPropagation();
                        await addSongToPlaylist(songId, playlist.id);
                        contextMenu.classList.add('hidden');
                    };
                    subMenu.appendChild(playlistItemEl);
                });
            }

            addToPlaylistEl.appendChild(subMenu);
            addToPlaylistEl.onmouseenter = () => subMenu.classList.remove('hidden');
            addToPlaylistEl.onmouseleave = () => subMenu.classList.add('hidden');
            contextMenu.appendChild(addToPlaylistEl);

            contextMenu.appendChild(document.createElement('hr')).className = 'border-theme my-1';

            if (currentView === 'playlist') {
                const removeFromPlaylistEl = document.createElement('div');
                removeFromPlaylistEl.textContent = 'Remover desta playlist';
                removeFromPlaylistEl.className = 'px-3 py-2 hover:bg-highlight cursor-pointer';
                removeFromPlaylistEl.onclick = () => {
                     showConfirmation('Remover Música', `Tem certeza que deseja remover esta música da playlist?`, () => removeSongFromPlaylist(songId, currentViewId));
                    contextMenu.classList.add('hidden');
                };
                contextMenu.appendChild(removeFromPlaylistEl);
            }

            const deleteFromLibraryEl = document.createElement('div');
            deleteFromLibraryEl.textContent = 'Excluir da biblioteca';
            deleteFromLibraryEl.className = 'px-3 py-2 text-red-400 hover:bg-red-600/20 cursor-pointer';
            deleteFromLibraryEl.onclick = () => {
                showConfirmation('Excluir Música', 'Esta ação é irreversível. A música será removida da sua biblioteca e de todas as playlists.', () => deleteSongFromLibrary(songId));
                contextMenu.classList.add('hidden');
            };
            contextMenu.appendChild(deleteFromLibraryEl);
            
            const menuWidth = contextMenu.offsetWidth;
            const menuHeight = contextMenu.offsetHeight;
            let top = event.pageY;
            let left = event.pageX;

            if (left + menuWidth > window.innerWidth) left = window.innerWidth - menuWidth - 10;
            if (top + menuHeight > window.innerHeight) top = window.innerHeight - menuHeight - 10;

            contextMenu.style.top = `${top}px`;
            contextMenu.style.left = `${left}px`;
            
            if (left + menuWidth * 2 > window.innerWidth) {
                subMenu.style.left = 'auto'; subMenu.style.right = '100%';
            } else {
                subMenu.style.right = 'auto'; subMenu.style.left = '100%';
            }
        }
        
        async function openPlaylistModal(playlistId = null) {
            editingPlaylistId = playlistId;
            newCoverBlob = null;
            if (playlistId) {
                const playlist = await db.get('playlists', playlistId);
                playlistModalName.value = playlist.name;
                playlistModalCoverPreview.src = playlist.coverImageBlob ? URL.createObjectURL(playlist.coverImageBlob) : 'https://placehold.co/160x160/3e3e3e/b3b3b3?text=�';
            } else {
                playlistModalName.value = `Minha Playlist #${playlists.length + 1}`;
                playlistModalCoverPreview.src = 'https://placehold.co/160x160/3e3e3e/b3b3b3?text=🎵';
            }
            playlistEditModal.classList.remove('hidden');
        }

        async function savePlaylistDetails() {
            const name = playlistModalName.value.trim();
            if (!name) {
                showError('Erro', 'O nome da playlist não pode estar vazio.');
                return;
            }

            const wasCreating = !editingPlaylistId;
            let playlist;
            if (editingPlaylistId) {
                playlist = await db.get('playlists', editingPlaylistId);
            } else {
                playlist = { name, songIds: [], createdAt: new Date() };
            }

            playlist.name = name;
            if (newCoverBlob) {
                playlist.coverImageBlob = newCoverBlob;
            }

            const savedId = await db.put('playlists', playlist);
            const finalPlaylistId = editingPlaylistId || savedId;
            
            playlistEditModal.classList.add('hidden');

            await loadAllData();

            const currentView = document.body.dataset.currentView;
            const currentViewId = document.body.dataset.currentViewId ? parseInt(document.body.dataset.currentViewId) : null;
            
            if (currentView) {
                renderView(currentView, wasCreating ? finalPlaylistId : currentViewId);
            }
        }

        async function removeSongFromPlaylist(songId, playlistId) {
            const playlist = await db.get('playlists', playlistId);
            if (!playlist || !playlist.songIds) return;
            playlist.songIds = playlist.songIds.filter(id => id !== songId);
            await db.put('playlists', playlist);
            setStatus('Música removida da playlist.', 'success');
            await loadAllData();
            renderView('playlist', playlistId);
        }

        async function deleteSongFromLibrary(songId) {
            await db.delete('songs', songId);
            const allPlaylists = await db.getAll('playlists');
            const updatePromises = allPlaylists.map(p => {
                if (p.songIds && p.songIds.includes(songId)) {
                    p.songIds = p.songIds.filter(id => id !== songId);
                    return db.put('playlists', p);
                }
                return Promise.resolve();
            });
            await Promise.all(updatePromises);
            setStatus('Música excluída da biblioteca.', 'success');
            
            const currentView = document.body.dataset.currentView;
            const currentViewId = document.body.dataset.currentViewId ? parseInt(document.body.dataset.currentViewId) : null;
            await loadAllData();
            renderView(currentView, currentViewId);
        }

        async function deletePlaylist(playlistId) {
            await db.delete('playlists', playlistId);
            setStatus('Playlist excluída.', 'success');
            await loadAllData();
            renderView('playlists');
        }

        async function deleteAllHistory() {
            await db.clear('playHistory');
            await db.clear('showHistory');
            setStatus('Histórico de reprodução e de shows apagado.', 'success');
            await loadAllData();
            renderView('history');
        }

        function toggleSelectionMode(force, context) {
            isSelectionMode = force;
            if (!isSelectionMode) {
                selectedSongIds.clear();
            }
            
            if (context === 'playlist') {
                const playlistId = parseInt(document.body.dataset.currentViewId);
                renderView('playlist', playlistId);
            } else {
                renderView('songs');
            }
        }

        function updateSelection(songId, isChecked) {
            if (isChecked) {
                selectedSongIds.add(songId);
            } else {
                selectedSongIds.delete(songId);
            }
            updateLibraryMenuState();
            updatePlaylistMenuState();
        }

        function updateLibraryMenuState() {
            const selectBtn = document.getElementById('library-select-btn');
            const deleteBtn = document.getElementById('delete-selected-songs-btn');
            if (!selectBtn) return;

            selectBtn.classList.toggle('active-blue', isSelectionMode);

            if (isSelectionMode && selectedSongIds.size > 0) {
                if (deleteBtn) deleteBtn.classList.remove('hidden');
            } else {
                if (deleteBtn) deleteBtn.classList.add('hidden');
            }
        }
        
        function updatePlaylistMenuState() {
            const selectBtn = document.getElementById('playlist-select-btn');
            const deleteSelectedBtn = document.getElementById('delete-selected-from-playlist-btn');
            const deletePlaylistBtn = document.getElementById('delete-playlist-btn');
            const addSongsBtn = document.getElementById('add-songs-to-playlist-btn');
            const playBtn = document.getElementById('play-playlist-btn');

            if (!selectBtn) return;

            selectBtn.classList.toggle('active-blue', isSelectionMode);

            const shouldShowRegularButtons = !isSelectionMode;
            if(deletePlaylistBtn) deletePlaylistBtn.classList.toggle('hidden', !shouldShowRegularButtons);
            if(addSongsBtn) addSongsBtn.classList.toggle('hidden', !shouldShowRegularButtons);
            if(playBtn) playBtn.classList.toggle('hidden', !shouldShowRegularButtons);

            if (isSelectionMode && selectedSongIds.size > 0) {
                if(deleteSelectedBtn) deleteSelectedBtn.classList.remove('hidden');
            } else {
                if(deleteSelectedBtn) deleteSelectedBtn.classList.add('hidden');
            }
        }
        
        function deleteSelectedSongs() {
            const count = selectedSongIds.size;
            if (count === 0) return;
            showConfirmation(
                `Excluir ${count} Música${count > 1 ? 's' : ''}`,
                `Tem certeza que deseja excluir as ${count} músicas selecionadas? Esta ação é irreversível.`,
                async () => {
                    const deletePromises = [];
                    for (const songId of selectedSongIds) {
                        deletePromises.push(db.delete('songs', songId));
                    }
                    await Promise.all(deletePromises);

                    const allPlaylists = await db.getAll('playlists');
                    const updatePromises = allPlaylists.map(p => {
                        let changed = false;
                        if (p.songIds) {
                           const originalSize = p.songIds.length;
                           p.songIds = p.songIds.filter(id => !selectedSongIds.has(id));
                           if (p.songIds.length !== originalSize) changed = true;
                        }
                        if(changed) return db.put('playlists', p);
                        return Promise.resolve();
                    });
                    await Promise.all(updatePromises);

                    setStatus(`${count} música${count > 1 ? 's' : ''} excluída${count > 1 ? 's' : ''}.`, 'success');
                    toggleSelectionMode(false);
                    await loadAllData();
                    renderView('songs');
                }
            );
        }

        async function deleteSelectedSongsFromPlaylist(playlistId) {
            const count = selectedSongIds.size;
            if (count === 0) return;
            const playlist = await db.get('playlists', playlistId);
            if (!playlist) return;

            showConfirmation(
                `Remover ${count} Música${count > 1 ? 's' : ''}`,
                `Tem certeza que deseja remover as ${count} músicas selecionadas da playlist "${playlist.name}"?`,
                async () => {
                    playlist.songIds = playlist.songIds.filter(id => !selectedSongIds.has(id));
                    await db.put('playlists', playlist);

                    setStatus(`${count} música${count > 1 ? 's' : ''} removida${count > 1 ? 's' : ''} da playlist.`, 'success');
                    selectedSongIds.clear();
                    isSelectionMode = false;
                    await loadAllData();
                    renderView('playlist', playlistId);
                }
            );
        }

        async function deleteAllSongsFromLibrary() {
            await db.clear('songs');
            await db.clear('playHistory');
            await db.clear('showHistory');
            
            const allPlaylists = await db.getAll('playlists');
            const updatePromises = allPlaylists.map(p => {
                p.songIds = [];
                return db.put('playlists', p);
            });
            await Promise.all(updatePromises);
            
            setStatus('Todas as músicas foram excluídas.', 'success');
            
            stopCurrentSource();
            currentSong = null;
            playbackQueue = [];
            lastPlayedContext = [];
            playedSongsStack = [];
            updatePlayerUI({ title: 'Nenhuma música tocando', artist: '---', imageBlob: null, duration: 0 }); 
            
            await loadAllData();
            renderView('songs');
        }

        function initializePlayerState() {
            volumeBar.value = 50;
            lastVolume = 0.5;
            if (mainGainNode) mainGainNode.gain.value = 0.5;
            volumeBar.style.backgroundSize = '50% 100%';
            updateVolumeIcon(0.5);
        }

        function getNextSong() {
            if (repeatMode === 'one' && currentSong) return currentSong;
            if (playbackQueue.length > 0) return playbackQueue[0];
            if (repeatMode === 'all' && lastPlayedContext.length > 0) return lastPlayedContext[0];
            return null;
        }

        function showUpNextNotification() {
            if (!syncPanel.classList.contains('hidden')) return;
            
            const nextSong = getNextSong();
            
            if (nextSong) {
                // Calculate remaining time of the current song
                const duration = currentAudioBuffer ? currentAudioBuffer.duration : 0;
                const currentTime = isPlaying ? playbackStartOffset + (audioContext.currentTime - playbackStartTime) : playbackStartOffset;
                const remainingTime = duration - currentTime;

                // Determine notification display duration (min 0.5s, max 8s, or remaining time)
                const notificationDisplayDuration = Math.max(0.5, Math.min(8, remainingTime));

                upNextNotificationShown = true;
                upNextArt.src = nextSong.imageBlob ? URL.createObjectURL(nextSong.imageBlob) : 'https://placehold.co/48x48/121212/b3b3b3?text=🎵';
                upNextTitle.textContent = nextSong.title;
                
                upNextNotification.classList.remove('hidden');
                setTimeout(() => upNextNotification.classList.add('show'), 10);

                upNextTimer.style.transition = 'none';
                upNextTimer.style.width = '0%';
                setTimeout(() => {
                    upNextTimer.style.transition = `width ${notificationDisplayDuration}s linear`; // Use dynamic duration
                    upNextTimer.style.width = '100%';
                }, 100);

                upNextTimeout = setTimeout(hideUpNextNotification, notificationDisplayDuration * 1000); // Use dynamic duration
            }
        }

        function hideUpNextNotification() {
            upNextNotification.classList.remove('show');
            setTimeout(() => {
                upNextNotification.classList.add('hidden');
                if (upNextTimer) {
                    upNextTimer.style.transition = 'none';
                    upNextTimer.style.width = '0%';
                }
            }, 500);
        }

        function toggleShowTimerPanel() {
            showTimerPanel.classList.toggle('hidden');
            toggleShowTimerBtn.classList.toggle('active-blue', !showTimerPanel.classList.contains('hidden'));
        }

        function updateShowTimerDisplay() {
            let elapsed = showTimerElapsed;
            if (showTimerActive) {
                elapsed += Date.now() - showTimerStartTime;
            }
            showTimerDisplay.textContent = formatTime(elapsed / 1000, true);
        }

        function startPauseShowTimer() {
            showTimerActive = !showTimerActive;
            if (showTimerActive) {
                if (showTimerPlayHistoryIds.length === 0) {
                    showTimerPlayHistoryIds.push(currentHistoryEntryId);
                }
                showTimerStartTime = Date.now();
                showTimerInterval = setInterval(updateShowTimerDisplay, 1000);
                showTimerPlayPauseIcon.className = 'ph-bold ph-pause text-md';
                showTimerPlayPauseText.textContent = 'Pausar';
            } else {
                showTimerElapsed += Date.now() - showTimerStartTime;
                clearInterval(showTimerInterval);
                showTimerPlayPauseIcon.className = 'ph-bold ph-play text-md';
                showTimerPlayPauseText.textContent = 'Continuar';
            }
        }

        function resetShowTimer() {
            showTimerActive = false;
            clearInterval(showTimerInterval);
            showTimerElapsed = 0;
            showTimerStartTime = 0;
            showTimerPlayHistoryIds = [];
            updateShowTimerDisplay();
            showTimerPlayPauseIcon.className = 'ph-bold ph-play text-md';
            showTimerPlayPauseText.textContent = 'Iniciar';
        }

        async function saveShowTimer() {
            if (showTimerElapsed === 0 && !showTimerActive) {
                setStatus('Inicie o temporizador para salvar.', 'error');
                return;
            }
            let finalTime = showTimerElapsed;
            if (showTimerActive) {
                finalTime += Date.now() - showTimerStartTime;
            }
            
            const showRecord = {
                savedAt: new Date(),
                duration: finalTime / 1000,
                playHistoryIds: [...new Set(showTimerPlayHistoryIds)]
            };
            await db.add('showHistory', showRecord);
            setStatus(`Tempo de show salvo: ${formatTime(finalTime / 1000, true)}`, 'success');
            await refreshActiveHistoryTab();
            resetShowTimer();
        }
        
        function initHighlightCarousel(type, data) {
            const card = document.getElementById(`highlight-card-${type}`);
            if (!card || !data || data.length < 1) return;

            const newCard = card.cloneNode(true);
            card.parentNode.replaceChild(newCard, card);

            const imageEl = newCard.querySelector('img');
            const contentContainer = newCard.querySelector('.relative.z-10');
            const titleEl = newCard.querySelector(`#highlight-title-${type}`);
            const subtitleEl = newCard.querySelector(`#highlight-subtitle-${type}`);
            const progressSegments = newCard.querySelectorAll('.progress-segment');

            let currentIndex = 0;
            let carouselTimeoutId = null;
            const DURATION = 7000;
            const FADE_TIME = 400;

            if (highlightIntervals[type]) {
                clearTimeout(highlightIntervals[type]);
            }

            function scheduleNext(delay) {
                clearTimeout(carouselTimeoutId);
                if (data.length > 1) {
                    carouselTimeoutId = setTimeout(() => {
                        currentIndex = (currentIndex + 1) % data.length;
                        updateView(false);
                    }, delay);
                    highlightIntervals[type] = carouselTimeoutId;
                }
            }

            function updateView(isInstant = false) {
                const item = data[currentIndex];
                if (!item) return;

                const elementsToFade = [imageEl, contentContainer];

                const performUpdate = () => {
                    imageEl.src = item.imageBlob ? URL.createObjectURL(item.imageBlob) : 'https://placehold.co/200x200/181818/b3b3b3?text=🎵';
                    titleEl.textContent = item.title || item.name;
                    subtitleEl.textContent = item.artist || `${item.count} reproduções`;

                    progressSegments.forEach((segment, i) => {
                        const fill = segment.querySelector('.progress-fill');
                        fill.style.transition = 'none';
                        fill.style.width = (i < currentIndex) ? '100%' : '0%';
                        segment.classList.remove('active');
                    });

                    setTimeout(() => {
                        const activeSegment = progressSegments[currentIndex];
                        if (activeSegment) {
                            activeSegment.classList.add('active');
                            const fill = activeSegment.querySelector('.progress-fill');
                            fill.style.transition = `width ${DURATION}ms linear`;
                            fill.style.width = '100%';
                        }
                    }, 50);

                    elementsToFade.forEach(el => {
                        el.style.transition = `opacity ${FADE_TIME}ms ease-in-out`;
                        el.classList.remove('opacity-0');
                    });
                    
                    scheduleNext(DURATION);
                };

                if (isInstant) {
                    performUpdate();
                } else {
                    elementsToFade.forEach(el => el.classList.add('opacity-0'));
                    setTimeout(performUpdate, FADE_TIME);
                }
            }

            newCard.addEventListener('click', () => {
                currentIndex = (currentIndex + 1) % data.length;
                updateView(false);
            });

            newCard.addEventListener('mouseenter', () => clearTimeout(carouselTimeoutId));
            newCard.addEventListener('mouseleave', () => scheduleNext(DURATION));

            updateView(true);
        }

        async function openAddSongsModal(pId) {
            playlistIdToAddSongs = pId;
            const playlist = await db.get('playlists', pId);
            addSongsPlaylistName.textContent = playlist.name;
            renderAddSongsList(playlist.songIds || []);
            addSongsModal.classList.remove('hidden');
        }

        function renderAddSongsList(existingSongIds = [], query = '') {
            const filteredSongs = songs.filter(s => 
                s.title.toLowerCase().includes(query.toLowerCase()) || 
                s.artist.toLowerCase().includes(query.toLowerCase())
            );

            addSongsList.innerHTML = filteredSongs.map(song => {
                const alreadyInPlaylist = existingSongIds.includes(song.id);
                return `
                    <div class="flex items-center gap-4 p-2 rounded-lg hover:bg-highlight">
                        <img src="${song.imageBlob ? URL.createObjectURL(song.imageBlob) : 'https://placehold.co/40x40/121212/b3b3b3?text=🎵'}" class="w-10 h-10 rounded">
                        <div class="flex-1">
                            <p class="font-semibold text-primary truncate">${song.title}</p>
                            <p class="text-sm text-secondary truncate">${song.artist}</p>
                        </div>
                        <button 
                            class="add-song-btn ${alreadyInPlaylist ? 'bg-green-500 text-white' : 'bg-brand text-white'} font-bold py-1 px-3 rounded-full text-sm" 
                            data-song-id="${song.id}" 
                            ${alreadyInPlaylist ? 'disabled' : ''}>
                            ${alreadyInPlaylist ? 'Adicionada' : 'Adicionar'}
                        </button>
                    </div>
                `;
            }).join('');

            addSongsList.querySelectorAll('.add-song-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const songId = parseInt(btn.dataset.songId);
                    await addSongToPlaylist(songId, playlistIdToAddSongs);
                    btn.textContent = 'Adicionada';
                    btn.classList.remove('bg-brand');
                    btn.classList.add('bg-green-500');
                    btn.disabled = true;
                });
            });
        }

        async function addSongToPlaylist(songId, playlistId) {
            const playlist = await db.get('playlists', playlistId);
            if (!playlist.songIds) playlist.songIds = [];
            if (!playlist.songIds.includes(songId)) {
                playlist.songIds.push(songId);
                await db.put('playlists', playlist);
                setStatus('Música adicionada!', 'success');
                
                await loadAllData();
                const currentView = document.body.dataset.currentView;
                const currentViewId = document.body.dataset.currentViewId ? parseInt(document.body.dataset.currentViewId) : null;
                renderView(currentView, currentViewId);

            } else {
                setStatus('Música já está na playlist.', 'info');
            }
        }

        function makePanelInteractive(panelId) {
            const panel = document.getElementById(panelId);
            const dragHandle = document.getElementById(panelId + "-drag-handle");
            
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

            if (dragHandle) dragHandle.onmousedown = dragMouseDown;

            function dragMouseDown(e) {
                e = e || window.event;
                if (e.target.closest('button')) return;
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }

            function elementDrag(e) {
                e = e || window.event;
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                panel.style.top = (panel.offsetTop - pos2) + "px";
                panel.style.left = (panel.offsetLeft - pos1) + "px";
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') {
                document.body.classList.add('light');
                themeIcon.className = 'ph-bold ph-moon text-xl';
            } else {
                document.body.classList.remove('light');
                themeIcon.className = 'ph-bold ph-sun text-xl';
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('light');
            const isLight = document.body.classList.contains('light');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            themeIcon.className = isLight ? 'ph-bold ph-moon text-xl' : 'ph-bold ph-sun text-xl';
            if (document.body.dataset.currentView === 'history') {
                renderHistoryView();
            }
        }
        
        function updateVolumeIcon(volume) {
            if (isMuted || volume === 0) {
                volumeIcon.className = 'ph-bold ph-speaker-slash text-xl';
            } else {
                if (volume > 0.5) {
                    volumeIcon.className = 'ph-bold ph-speaker-high text-xl';
                } else {
                    volumeIcon.className = 'ph-bold ph-speaker-low text-xl';
                }
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            if (mainGainNode) {
                mainGainNode.gain.value = isMuted ? 0 : lastVolume;
            }
            volumeBar.value = isMuted ? 0 : lastVolume * 100;
            volumeBar.style.backgroundSize = `${volumeBar.value}% 100%`;
            updateVolumeIcon(isMuted ? 0 : lastVolume);
        }

        function startProgressUpdater() {
            const update = () => {
                if (!isPlaying || !currentAudioBuffer) {
                    cancelAnimationFrame(progressUpdateAnimation);
                    return;
                }
                const duration = currentAudioBuffer.duration;
                const currentTime = playbackStartOffset + (audioContext.currentTime - playbackStartTime);
                
                if (currentTime >= duration) {
                    cancelAnimationFrame(progressUpdateAnimation);
                    return;
                }

                const progressPercent = (currentTime / duration) * 100;

                progressBar.value = progressPercent;
                progressBar.style.backgroundSize = `${progressPercent}% 100%`;
                currentTimeEl.textContent = formatTime(currentTime);

                if (lyricsProgressBar) {
                    lyricsProgressBar.value = progressPercent;
                    lyricsProgressBar.style.backgroundSize = `${progressPercent}% 100%`;
                    lyricsCurrentTimeEl.textContent = formatTime(currentTime);
                }

                if (!syncPanel.classList.contains('hidden')) {
                    syncProgressBar.value = progressPercent;
                    syncProgressBar.style.backgroundSize = `${progressPercent}% 100%`;
                    syncCurrentTime.textContent = formatTime(currentTime);
                }

                if (!lyricsPanel.classList.contains('hidden')) syncLyrics(currentTime);

                if ((duration - currentTime < 10) && !upNextNotificationShown) {
                    showUpNextNotification();
                }

                progressUpdateAnimation = requestAnimationFrame(update);
            };
            progressUpdateAnimation = requestAnimationFrame(update);
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('close-error-modal').addEventListener('click', () => document.getElementById('error-modal').classList.add('hidden'));
        cancelConfirmationBtn.addEventListener('click', hideConfirmation);
        confirmActionBtn.addEventListener('click', () => {
            if (typeof confirmCallback === 'function') confirmCallback();
            hideConfirmation();
        });

        playPauseBtn.addEventListener('click', togglePlayPause);
        nextBtn.addEventListener('click', playNext);
        prevBtn.addEventListener('click', playPrev);
        shuffleBtn.addEventListener('click', toggleShuffle);
        repeatBtn.addEventListener('click', cycleRepeatMode);

        lyricsPlayPauseBtn.addEventListener('click', togglePlayPause);
        lyricsNextBtn.addEventListener('click', playNext);
        lyricsPrevBtn.addEventListener('click', playPrev);
        lyricsShuffleBtn.addEventListener('click', toggleShuffle);
        lyricsRepeatBtn.addEventListener('click', cycleRepeatMode);

        queueBtn.addEventListener('click', () => setQueueOpen(!isQueueOpen));
        lyricsQueueBtn.addEventListener('click', () => setQueueOpen(!isQueueOpen));
        closeQueueBtn.addEventListener('click', () => setQueueOpen(false));
        
        lyricsBtn.addEventListener('click', () => {
            if (!currentSong) { setStatus('Selecione uma música primeiro', 'error'); return; }
            const song = currentSong;
            lyricsTextarea.value = song.lyrics || '';
            renderLyricsDisplay();
            toggleLyricsEditMode(false);
            document.body.classList.add('lyrics-active');
            lyricsPanel.classList.remove('hidden');
        });

        closeLyricsBtn.addEventListener('click', () => {
            lyricsPanel.classList.add('hidden');
            document.body.classList.remove('lyrics-active');
            if (!showTimerPanel.classList.contains('hidden')) {
                toggleShowTimerPanel();
            }
        });

        fontSizeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            fontSizeDropdown.classList.toggle('hidden');
            moreOptionsDropdown.classList.add('hidden');
        });
        moreOptionsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            moreOptionsDropdown.classList.toggle('hidden');
            fontSizeDropdown.classList.add('hidden');
        });
        
        editLyricsBtn.addEventListener('click', () => {
            if (currentSong) {
                lyricsTextarea.value = currentSong.lyrics || '';
            }
            toggleLyricsEditMode(true);
            moreOptionsDropdown.classList.add('hidden');
        });
        saveLyricsChangesBtn.addEventListener('click', saveLyricsChanges);
        deleteLyricsBtn.addEventListener('click', () => { deleteLyrics(); moreOptionsDropdown.classList.add('hidden'); });
        startSyncBtn.addEventListener('click', () => { startSyncMode(); moreOptionsDropdown.classList.add('hidden'); });
        
        // New AI buttons event listeners
        generateLyricsAIButton.addEventListener('click', () => {
            // Call the AI function for lyrics generation
            callAIFunction('upload_and_process_lyrics');
        });

        detectChordsAIButton.addEventListener('click', () => {
            // Call the AI function for chord detection
            callAIFunction('detect_chords');
        });


        exitSyncBtn.addEventListener('click', () => {
            showConfirmation(
                'Cancelar Sincronização',
                'Seus dados de sincronização não salvos serão perdidos. Deseja sair?',
                () => {
                    syncPanel.classList.add('hidden');
                    syncPanel.classList.remove('flex');
                    lyricsPanel.classList.remove('hidden');
                    if (isPlaying) {
                        togglePlayPause();
                    }
                    syncLines = [];
                    syncIndex = 0;
                    syncedLyricsData = [];
                    isSyncWaitingForStart = false;
                }
            );
        });
        
        syncPlayPauseBtn.addEventListener('click', () => {
            if (isSyncWaitingForStart) return;
            togglePlayPause();
        });
        
        tapSyncBtn.addEventListener('click', tapSync);
        finishSyncBtn.addEventListener('click', finishSync);
        
        const setupProgressBarInput = (bar) => {
            bar.addEventListener('input', () => {
                if (currentAudioBuffer) {
                    const newTime = (bar.value / 100) * currentAudioBuffer.duration;
                    if(isPlaying) {
                        audioContext.suspend().then(() => {
                            startPlayback(newTime);
                            audioContext.resume();
                        });
                    } else {
                        playbackStartOffset = newTime;
                        currentTimeEl.textContent = formatTime(newTime);
                        lyricsCurrentTimeEl.textContent = formatTime(newTime);
                    }
                }
            });
        };
        setupProgressBarInput(progressBar);
        setupProgressBarInput(lyricsProgressBar);
        setupProgressBarInput(syncProgressBar);

        volumeIconBtn.addEventListener('click', toggleMute);
        volumeBar.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            if (volume > 0) isMuted = false;
            lastVolume = volume;
            if (mainGainNode) {
                mainGainNode.gain.value = isMuted ? 0 : volume;
            }
            volumeBar.style.backgroundSize = `${e.target.value}% 100%`;
            updateVolumeIcon(volume);
        });

        navHome.addEventListener('click', (e) => { e.preventDefault(); renderView('home'); });
        navSearch.addEventListener('click', (e) => { e.preventDefault(); renderView('search'); });
        navHistory.addEventListener('click', (e) => { e.preventDefault(); renderView('history'); });
        navLibrary.addEventListener('click', (e) => { e.preventDefault(); renderView('songs'); });
        navHomeMobile.addEventListener('click', (e) => { e.preventDefault(); renderView('home'); });
        navSearchMobile.addEventListener('click', (e) => { e.preventDefault(); renderView('search'); });
        navHistoryMobile.addEventListener('click', (e) => { e.preventDefault(); renderView('history'); });
        navLibraryMobile.addEventListener('click', (e) => { e.preventDefault(); renderView('songs'); });

        // Removido o event listener do botão de criar playlist da sidebar, agora o botão está na view da biblioteca
        // createPlaylistBtn.addEventListener('click', () => openPlaylistModal()); 
        closePlaylistEditModalBtn.addEventListener('click', () => playlistEditModal.classList.add('hidden'));
        savePlaylistDetailsBtn.addEventListener('click', savePlaylistDetails);
        playlistCoverInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                newCoverBlob = file;
                playlistModalCoverPreview.src = URL.createObjectURL(file);
            }
        });

        playerAlbumArt.addEventListener('click', () => { if(currentSong) nowPlayingFullscreen.classList.remove('hidden')});
        playerTitle.addEventListener('click', () => { if(currentSong) nowPlayingFullscreen.classList.remove('hidden')});
        closeNowPlayingFullscreenBtn.addEventListener('click', () => nowPlayingFullscreen.classList.add('hidden'));
        goToLyricsBtn.addEventListener('click', () => {
            nowPlayingFullscreen.classList.add('hidden');
            lyricsBtn.click();
        });
        
        increaseLyricsFontBtn.addEventListener('click', () => { lyricsFontSize = Math.min(4, lyricsFontSize + 0.1); applyLyricsFontSize(); });
        decreaseLyricsFontBtn.addEventListener('click', () => { lyricsFontSize = Math.max(0.8, lyricsFontSize - 0.1); applyLyricsFontSize(); });

        toggleShowTimerBtn.addEventListener('click', toggleShowTimerPanel);
        showTimerPlayPauseBtn.addEventListener('click', startPauseShowTimer);
        showTimerResetBtn.addEventListener('click', resetShowTimer);
        showTimerSaveBtn.addEventListener('click', saveShowTimer);

        closeAddSongsModalBtn.addEventListener('click', () => addSongsModal.classList.add('hidden'));
        addSongsSearchInput.addEventListener('input', async () => {
            const playlist = await db.get('playlists', playlistIdToAddSongs);
            renderAddSongsList(playlist.songIds || [], addSongsSearchInput.value);
        });
        
        themeToggleBtn.addEventListener('click', toggleTheme);

        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target)) contextMenu.classList.add('hidden');
            
            const fontMenuContainer = document.getElementById('font-size-menu-container');
            if (fontMenuContainer && !fontMenuContainer.contains(e.target)) {
                fontSizeDropdown.classList.add('hidden');
            }

            const moreOptionsContainer = document.getElementById('more-options-menu-container');
            if (moreOptionsContainer && !moreOptionsContainer.contains(e.target)) {
                moreOptionsDropdown.classList.add('hidden');
            }
        });

        window.addEventListener('resize', () => {
            updatePlayerVisibility(document.body.classList.contains('player-active'));
        });

        function initializeDragAndDrop() {
            let draggedItem = null;

            queueList.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('queue-item')) {
                    draggedItem = e.target;
                    setTimeout(() => {
                        if (draggedItem) {
                            draggedItem.classList.add('dragging');
                        }
                    }, 0);
                }
            });

            queueList.addEventListener('dragend', () => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                }
            });
            
            queueList.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedItem) return;

                const afterElement = getDragAfterElement(queueList, e.clientY);
                
                if (afterElement == null) {
                    queueList.appendChild(draggedItem);
                } else {
                    queueList.insertBefore(draggedItem, afterElement);
                }
            });

            queueList.addEventListener('drop', (e) => {
                e.preventDefault();
                if (!draggedItem) return;
                
                const newIdOrder = Array.from(queueList.querySelectorAll('.queue-item'))
                    .map(item => parseInt(item.dataset.songId, 10));

                const songMap = new Map(playbackQueue.map(song => [song.id, song]));

                playbackQueue = newIdOrder.map(id => songMap.get(id)).filter(Boolean);

                renderQueue();
            });
        }

        // Nova função para inicializar o drag and drop na playlist
        function initializePlaylistDragAndDrop(playlistId) {
            const playlistSongList = document.getElementById('playlist-song-list');
            if (!playlistSongList) return;

            let draggedItem = null;

            playlistSongList.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('song-item-row')) {
                    draggedItem = e.target;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', draggedItem.dataset.songId);
                    setTimeout(() => {
                        if (draggedItem) {
                            draggedItem.classList.add('dragging');
                        }
                    }, 0);
                }
            });

            playlistSongList.addEventListener('dragend', () => {
                if (draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                }
            });
            
            playlistSongList.addEventListener('dragover', (e) => {
                e.preventDefault();
                if (!draggedItem) return;
                e.dataTransfer.dropEffect = 'move';

                const afterElement = getDragAfterElement(playlistSongList, e.clientY);
                
                if (afterElement == null) {
                    playlistSongList.appendChild(draggedItem);
                } else {
                    playlistSongList.insertBefore(draggedItem, afterElement);
                }
            });

            playlistSongList.addEventListener('drop', async (e) => {
                e.preventDefault();
                if (!draggedItem) return;
                
                const newIdOrder = Array.from(playlistSongList.querySelectorAll('.song-item-row'))
                    .map(item => parseInt(item.dataset.songId, 10));

                // Atualizar a playlist no IndexedDB
                const playlist = await db.get('playlists', playlistId);
                if (playlist) {
                    playlist.songIds = newIdOrder;
                    await db.put('playlists', playlist);
                    setStatus('Ordem da playlist salva!', 'success');
                    // Recarregar a view da playlist para refletir a nova ordem visualmente
                    renderView('playlist', playlistId);
                }
                draggedItem = null;
            });
        }


        function parseLyrics(text) {
            if (!text || !text.trim()) return [];
            const lines = text.split('\n');
            const result = [];

            for (const line of lines) {
                const lrcMatch = line.match(/^\[(\d{2}):(\d{2})[.:](\d{2,3})\](.*)/);
                let cleanText = line;
                let time = null;
                let chords = [];

                if (lrcMatch) {
                    time = parseInt(lrcMatch[1], 10) * 60 + parseInt(lrcMatch[2], 10) + parseInt(lrcMatch[3], 10) / (lrcMatch[3].length === 2 ? 100 : 1000);
                    cleanText = lrcMatch[4].trim();
                }

                // Extract inline chords (e.g., [C], [Am])
                const chordMatches = [...cleanText.matchAll(/\[([A-G][b#]?(?:m|maj|min|dim|aug|sus|add)?(?:\d)*)?\]/g)];
                let lastIndex = 0;
                let textWithoutChords = '';
                chordMatches.forEach(match => {
                    const chord = match[1] || ''; // The matched chord, e.g., "C", "Am7"
                    const offset = match.index; // Character index where chord starts

                    // Add text before the chord
                    textWithoutChords += cleanText.substring(lastIndex, offset);

                    chords.push({ chord: chord.trim(), offset: textWithoutChords.length }); // Store chord and its position in the clean text
                    lastIndex = offset + match[0].length; // Move past the full [chord] tag
                });
                textWithoutChords += cleanText.substring(lastIndex); // Add any remaining text

                // Remove multiple spaces and trim
                textWithoutChords = textWithoutChords.replace(/\s+/g, ' ').trim();

                if (time !== null || textWithoutChords.length > 0 || chords.length > 0) {
                    result.push({ time, text: textWithoutChords, chords });
                }
            }
            return result;
        }

        // --- Frontend-Backend Communication Functions ---
        // Ajuste para detectar o URL do Codespaces automaticamente
        // Se estiver rodando no Codespaces, ele usará o URL da porta encaminhada (ex: https://port-5000-suacodespaceid.app.github.dev)
        // Caso contrário (ex: rodando localmente), ele usará 'http://localhost:5000'
        const BACKEND_URL = window.location.origin.replace(/-\d+$/, '-5000') || 'http://localhost:5000';

        async function callAIFunction(endpoint) {
            if (!currentSong || !currentSong.audioBlob) {
                setStatus('Nenhuma música carregada para processar.', 'error');
                return;
            }

            setStatus('Iniciando processamento de IA...', 'info');
            moreOptionsDropdown.classList.add('hidden'); // Esconde o menu

            const formData = new FormData();
            formData.append('audio', currentSong.audioBlob, currentSong.fileName);

            try {
                const response = await fetch(`${BACKEND_URL}/${endpoint}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    setStatus(`Tarefa de IA iniciada: ${data.task_id}`, 'info');
                    // Começar a verificar o status da tarefa
                    checkTaskStatus(data.task_id, endpoint);
                } else {
                    showError('Erro no Backend de IA', data.error || 'Erro desconhecido ao iniciar a tarefa.');
                    setStatus('Erro no processamento de IA.', 'error');
                }
            } catch (error) {
                console.error('Erro ao conectar com o backend de IA:', error);
                showError('Erro de Conexão', 'Não foi possível conectar ao serviço de IA. Verifique se o backend está rodando.');
                setStatus('Erro de conexão com IA.', 'error');
            }
        }

        // Função para verificar o status de uma tarefa (polling)
        async function checkTaskStatus(taskId, originalEndpoint) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`${BACKEND_URL}/task_status/${taskId}`);
                    const data = await response.json();

                    if (data.state === 'SUCCESS') {
                        clearInterval(interval);
                        setStatus('Processamento de IA concluído!', 'success');
                        if (originalEndpoint === 'upload_and_process_lyrics') {
                            // Atualizar a letra da música no IndexedDB e na memória
                            const songToUpdate = await db.get('songs', currentSong.id);
                            songToUpdate.lyrics = data.result.lyrics;
                            await db.put('songs', songToUpdate);
                            currentSong.lyrics = data.result.lyrics;
                            renderLyricsDisplay(); // Re-renderiza a letra com a nova versão
                            setStatus('Letra gerada por IA e salva!', 'success');
                        } else if (originalEndpoint === 'detect_chords') {
                            // Para exibir acordes, você pode:
                            // 1. Integrá-los na string de letra (formato [tempo] [cifra] texto)
                            // 2. Armazenar os acordes separadamente e exibir em uma camada diferente
                            // Por enquanto, apenas mostraremos um status de sucesso.
                            setStatus('Cifras detectadas por IA. (Verifique o console para os dados brutos se necessário)', 'success');
                            console.log("Acordes detectados:", data.result.chords);
                        }
                    } else if (data.state === 'FAILURE') {
                        clearInterval(interval);
                        showError('Erro no Processamento de IA', data.status || 'A tarefa de IA falhou.');
                        setStatus('Processamento de IA falhou.', 'error');
                    } else {
                        setStatus(`Processando (${data.progress}%): ${data.status}`, 'info');
                    }
                } catch (error) {
                    clearInterval(interval);
                    console.error('Erro ao verificar status da tarefa:', error);
                    showError('Erro de Conexão', 'Não foi possível verificar o status da tarefa de IA.');
                    setStatus('Erro de conexão com IA.', 'error');
                }
            }, 3000); // Verifica a cada 3 segundos
        }


        initDB();
        makePanelInteractive("show-timer-panel");

    </script>
</body>
</html>
